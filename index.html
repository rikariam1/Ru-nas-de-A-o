<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta charset="UTF-8" />
  <title>Personagem com Firebase</title>
  <style>
    body {
      background-color: #191919;
      font-family: Arial, sans-serif;
      
    }
    .container {
      position: relative;
      width: 100%;
      height: 100%;
    }
    /* Oculta visualmente as barras de rolagem, mas mantém a rolagem ativa */
html, body {
  scrollbar-width: none; /* Firefox */
}

html::-webkit-scrollbar,
body::-webkit-scrollbar {
  display: none; /* Chrome, Edge, Safari, Opera */
}
    
.circulos-wrapper {
  position: relative;
  width: 350px;
  height: 350px;
  margin: 0px auto; /* Centraliza na tela */
}

.circulo-principal {
  width: 350px;
  height: 350px;
  border: 6px solid white;
  border-radius: 50%;
  background-color: transparent;
  position: absolute;
  top: 0px;
  left: 50%;
  transform: translate(-50%);
  overflow: hidden;
  z-index: 1;
}

.circulo-principal img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

/* Pequenos */
.circulo-menor {
  width: 65px;
  height: 65px;
  border: 3px solid white;
  border-radius: 50%;
  background-color: #191919;
  position: absolute;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2;
}

.circulo-menor span {
  position: absolute;
  color: white;
  font-weight: bold;
  font-size: 15px;
  transform: translateY(110%);
}
.circulo-menor span::before {
  content: "";
  position: absolute;
  top: -3px;
  left: 50%;
  transform: translateX(-50%);
  width: 40px;
  height: 2px;
  background-color: white;
}
    .editavel {
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      font-size: 30px;
      font-weight: normal;
      text-align: center;
      outline: none;
      border: none;
      background: transparent;
      width: 60px;
    }

/* POSICIONAMENTO EM VOLTA DO CÍRCULO */
.centro {
  top: 92%;
  left: 50%;
  transform: translate(-50%);
}
.direita {
  top: 77%;
  left: 86%;
  transform: translate(-50%);
}
.direita-cima {
  top: 40%;
  left: 100%;
  transform: translate(-50%);
}
.esquerda {
  top: 77%;
  left: 14%;
  transform: translate(-50%);
}
.esquerda-cima {
  top: 40%;
  left: 0%;
  transform: translate(-50%);
}


    .barras-container {
      position: absolute; /* ou fixed, se quiser que fique fixo mesmo rolando */
      top: 425px;
      left: 600px;
      display: flex;
      flex-direction: column;
    }

    .bloco-barra {
      position: relative;
      width: 300px;
      margin-bottom: 20px;
    }
    .bar-title {
      color: #fff;
      font-weight: bold;
      font-size: 18px;
      text-align: center;
      margin-bottom: 5px;
    }
    .bar-container {
      width: 300px;
      height: 30px;
      background-color: #191919;
      border: 2px solid #fff;
      overflow: hidden;
      position: relative; /* mantém a estrutura */
    }
    /* Barras de vida, alma e sanidade */
    .bar, .negative-hp-bar {
      height: 100%;
      width: 0;
      transition: width 0.6s, background-color 0.3s;
    }
    /* Cores específicas das barras */
    .bar.hp {
      background-color: rgb(182, 36, 36);
    }
    .bar.alma {
      background-color: rgb(45, 168, 255);
    }
    .bar.sanidade {
      background-color: rgb(103, 1, 171);
    }
    /* Barra negativa de HP (por trás da barra principal) */
    .negative-hp-bar {
      background-color: black;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 0;
    }
    /* Barra extra positiva (excesso) */
    .positive-bar {
      background-color: orange;
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0;
      z-index: 1.5;
      pointer-events: none; /* não interfere em cliques */
      transition: width 0.6s;
    }
    /* Input central dentro da barra */
    .bar-input {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100px;
      border: none;
      background: none;
      color: #fff;
      font-weight: bold;
      text-align: center;
      z-index: 2;
      font-size: 16px;
      transition: opacity 1s;
    }
    /* Setas de controle das barras */
    .arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      color: #fff;
      cursor: pointer;
      z-index: 3;
      user-select: none;
    }
    .arrow.left-single {
      left: 30px;
      font-size: 28px;
    }
    .arrow.right-single {
      right: 30px;
      font-size: 28px;
    }
    .arrow.left-double {
      left: 5px;
      font-size: 28px;
    }
    .arrow.right-double {
      right: 5px;
      font-size: 28px;
    }
    /* Mensagem de "MORTO" */
    .dead-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 18px;
      font-weight: bold;
      display: none;
      z-index: 4;
    }
    
    /* Input file escondido (upload customizado) */
    input[type="file"] {
      display: none;
    }
    /* Container de infos à esquerda */
    .info-esquerda {
      position: absolute;
      left: 25px;
      top: 10px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      color: white;
    }
    /* Linha dentro do container de infos */
    .info-linha {
  display: flex;
  flex-direction: row; /* linha */
  align-items: center;
  gap: 10px;
}

    /* Labels dentro das linhas */
    .info-linha label {
      min-width: 50px;
      font-weight: bold;
    }
    /* Classe extra pra margem em labels específicas */
    .label-mov {
      margin-left: 10px;
    }
    /* Campos editáveis gerais */
    .campo-editavel {
      border: 1px solid white;
      padding: 5px 10px;
      color: white;
      background: transparent;
      width: 300px;
      height: 20px;
      outline: none;
      font-size: 15px;
      display: flex;
      align-items: center;
      justify-content: left;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    /* Versão pequena dos campos editáveis */
    .campo-editavel.pequeno {
      width: 50px;
      height: 20px;
      font-size: 25px;
      justify-content: center;
      font-weight: normal;
    }
    .habilidades-container {
      margin-top: 20px;
      position: absolute;
      top: 5%;
      left: 1050px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .habilidades-linha {
      display: flex;
      align-items: center;
      gap: 10px;
      color: white;
      font-weight: bold;
      font-size: 20px;
    }
    .campo-editavel.grande {
      width: 370px;
      height: 80vh;
      border: 2px solid white;
      color: white;
      background-color: transparent;
      padding: 5px;
      overflow-y: auto;
      overflow-x: hidden;
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: break-word;
      text-align: left;
      line-height: 1.2;
      display: block;          /* OU inline-block */
    }
    .container-pericias {
      position: absolute;
      top: 180px;  /* ajuste como quiser */
      left: 85px; /* ajuste como quiser */
      width: 320px;
      height: 585px;
    }
    .lista-pericias-completa {
      position: absolute;
      top: 0px;
      left: 0px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      z-index: 2;
      color: white;
      font-size: 15px;
    }
    .linha-pericia {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .linha-pericia.roxa .pericia,
    .linha-pericia.roxa .atributo {
      color: #ae48ee; /* roxo */
    }
    .pericia {
      width: 130px;
      text-align: left;
      font-weight: normal;
    }
    .atributo {
      width: 50px;
      text-align: left;
      font-weight: normal;
    }
    .campo-editavel-linha {
      border-bottom: 2px solid white;
      min-width: 80px;
      height: 20px;
      color: white;
      outline: none;
      background: transparent;
    }
    /* Container geral das resistências e vulnerabilidades */
    .resistencias-vulnerabilidades {
      position: absolute;
      top: 675px;
      left: 500px;
      display: flex;
      flex-direction: column;
      color: white;
      font-family: Arial, sans-serif;
    }
    /* Linha com uma resistência ou vulnerabilidade */
    .linha-rv {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    /* Label da linha */
    .linha-rv label {
      min-width: 165px;
      font-weight: bold;
      font-size: 14px;
    } 
    /* Campo editável da linha */
    .campo-linha-rv {
      width: 300px; /* largura fixa */
      height: 20px;
      padding: 2px 4px;
      border-bottom: 2px solid white;
      outline: none;
      color: white;
      overflow: auto;
      text-overflow: ellipsis;
    }
    /* Container das abas */
    .abas {
      position: absolute;         /* Define que será posicionado fora do fluxo normal */
      top: 0px;                    /* Posição vertical da aba na tela */
      left: 975px;                  /* Posição horizontal */
      display: flex;           /* Deixa lado a lado */
      border-bottom: 2px solid #333;
      margin-bottom: 20px;
      font-size: 14px;
    }
    /* Cada aba individual */
    .aba {
      padding: 10px 20px;
      color: white;
      cursor: pointer;
      position: relative;
      font-weight: bold;
    }
    /* Linha roxa embaixo da aba ativa */
    .aba.ativa::after {
      content: "";
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 3px;
      background-color: purple;
      }
    /* Esconde os conteúdos que não estão ativos */
    .conteudos .conteudo-aba {
      display: none;
    }
    .inventario-container {
      margin-top: 20px;
      position: absolute;
      top: 5%;
      left: 1050px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .inventario-linha {
      display: flex;
      align-items: center;
      gap: 10px;
      color: white;
      font-weight: bold;
      font-size: 20px;
    }
    .inventario-titulo {
      font-size: 20px;
    }
    .idolos-container {
      margin-top: 20px;
      position: absolute;
      top: 5%;
      left: 1050px;
      display: flex;
      flex-direction: column;
      gap: 10px; 
    }
    .notas-container {
      margin-top: 20px;
      position: absolute;
      top: 5%;
      left: 1050px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    @media screen and (max-width: 768px) {
  .container {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
  }
  .circulos-wrapper {
    width: 75vw;  /* 90% da largura da tela */
    height: 75vw; /* mantém quadrado */
  }
  .circulo-principal {
    width: 100%;
    height: 100%;
    border-width: 4px; /* borda menor pra não ficar pesado */
  }
  .circulo-menor {
    width: 16vw;   /* circulos menores também redimensionam */
    height: 16vw;
    border-width: 2px;
  }
    .info-esquerda {
    position: absolute;
    top: 350px;
    left: 50%;
    transform: translate(-50%);
    width: 85%;
    height: auto;
  }
    .barras-container {
      position: absolute; /* ou fixed, se quiser que fique fixo mesmo rolando */
      top: 550px;
      left: 50%;
      transform: translate(-50%);
      display: flex;
      flex-direction: column;
    }
    .abas {
      position: absolute;
      top: 1575px;
      left: 50%;
      transform: translate(-50%);
      font-size: 13px;
    }
    .aba {
      padding: 8px;
    }
  .habilidades-container,
  .inventario-container,
  .idolos-container,
  .notas-container {
    position: absolute;
    top: 1595px;
    left: 48%;
    transform: translate(-50%);
    width: 90vw;
    margin-top: 20px;
  }

  .campo-editavel.grande {
    width: 100%;
    height: 600px;
    margin-bottom: 15px;
  }

  .resistencias-vulnerabilidades {
    position: absolute;
    top: 800px;
    left: 50%;
    transform: translate(-50%);
    margin-top: 20px;
    width: 90%;
  }
  .linha-horizontal {
  position: absolute;
  top: 900px;
  width: 100%;
  height: 2px;
  background-color: white;
  margin: 20px 0; /* opcional, só pra dar respiro */
}
 .linha-horizontal-2 {
  position: absolute;
  top: 1550px;
  width: 100%;
  height: 2px;
  background-color: white;
  margin: 20px 0; /* opcional, só pra dar respiro */
}

  .container-pericias {
    position: absolute;
    top: 945px;
    left: 55%;
    transform: translate(-50%);
  }
  .lista-pericias-completa {
    font-size: 18px;
  }
}

  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB3g9cW1262DtgjD-t55iNCM2yYQf6ctTg",
      authDomain: "hp-bar-5337b.firebaseapp.com",
      databaseURL: "https://hp-bar-5337b-default-rtdb.firebaseio.com",
      projectId: "hp-bar-5337b",
      storageBucket: "hp-bar-5337b.appspot.com",
      messagingSenderId: "891062479752",
      appId: "1:891062479752:web:a94ee1b9ba5ddbb826683d",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>
</head>
<body>

  <div class="circulos-wrapper">
    <div class="circulo-principal" onclick="document.getElementById('upload').click()">
      <img id="preview" src="" alt="">
    </div>
    <input type="file" id="upload" accept="image/*" onchange="handleImage(event)" />

    <div class="circulo-menor centro"><div class="editavel" contenteditable="true" id="edit-vig"></div><span>VIG</span></div>
    <div class="circulo-menor direita"><div class="editavel" contenteditable="true" id="edit-agi"></div><span>PRE</span></div>
    <div class="circulo-menor direita-cima"><div class="editavel" contenteditable="true" id="edit-for"></div><span>INT</span></div>
    <div class="circulo-menor esquerda"><div class="editavel" contenteditable="true" id="edit-pre"></div><span>AGI</span></div>
    <div class="circulo-menor esquerda-cima"><div class="editavel" contenteditable="true" id="edit-int"></div><span>FOR</span></div>
  </div>

  <div class="info-esquerda">
  <div class="info-linha">
    <label>NOME</label>
    <div class="campo-editavel" contenteditable="true" id="info-nome"></div>
  </div>
  <div class="info-linha">
    <label>IDADE</label>
    <div class="campo-editavel" contenteditable="true" id="info-idade"></div>
  </div>
  <div class="info-linha">
    <label>RAÇA</label>
    <div class="campo-editavel" contenteditable="true" id="info-raca"></div>
  </div>
  <div class="info-linha">
    <label>LVL</label>
    <div class="campo-editavel pequeno" contenteditable="true" id="info-lvl"></div>
    <label class="label-mov">MOV</label>
    <div class="campo-editavel pequeno" contenteditable="true" id="info-mov"></div>
  </div>
</div>

  <!-- Barras -->
  <div class="barras-container">
  <div class="bloco-barra">
    <div class="bar-title vida">VIDA</div>
    <div class="bar-container">
      <div class="negative-hp-bar" id="negative-hp-bar"></div>
      <div class="positive-bar" id="hp-excesso"></div> <!-- excesso -->
      <div class="bar hp" id="hp-bar"></div>
      <div class="arrow left-single" onclick="changeHP(-1)">‹</div>
      <div class="arrow right-single" onclick="changeHP(1)">›</div>
      <div class="arrow left-double" onclick="changeHP(-5)">«</div>
      <div class="arrow right-double" onclick="changeHP(5)">»</div>
      <input type="text" id="hp-input" class="bar-input" value="0/0" oninput="updateHP(this.value)" />
      <div class="dead-message" id="dead-message">MORTO</div>
    </div>
  </div>

  <div class="bloco-barra">
    <div class="bar-title alma">ALMA</div>
    <div class="bar-container">
      <div class="positive-bar" id="alma-excesso"></div> <!-- excesso -->
      <div class="bar alma" id="alma-bar"></div>
      <div class="arrow left-single" onclick="changeBar('alma', -1)">‹</div>
      <div class="arrow right-single" onclick="changeBar('alma', 1)">›</div>
      <div class="arrow left-double" onclick="changeBar('alma', -5)">«</div>
      <div class="arrow right-double" onclick="changeBar('alma', 5)">»</div>
      <input type="text" id="alma-input" class="bar-input" value="0/0" oninput="updateBar('alma', this.value)" />
    </div>
  </div>

  <div class="bloco-barra">
    <div class="bar-title sanidade">SANIDADE</div>
    <div class="bar-container">
      <div class="positive-bar" id="sanidade-excesso"></div> <!-- excesso -->
      <div class="bar sanidade" id="sanidade-bar"></div>
      <div class="arrow left-single" onclick="changeBar('sanidade', -1)">‹</div>
      <div class="arrow right-single" onclick="changeBar('sanidade', 1)">›</div>
      <div class="arrow left-double" onclick="changeBar('sanidade', -5)">«</div>
      <div class="arrow right-double" onclick="changeBar('sanidade', 5)">»</div>
      <input type="text" id="sanidade-input" class="bar-input" value="0/0" oninput="updateBar('sanidade', this.value)" />
    </div>
  </div>
</div>


<div class="resistencias-vulnerabilidades">
  <div class="linha-rv">
    <label for="campo-resistencias">RESISTÊNCIAS</label>
    <div id="resistencias" class="campo-linha-rv" contenteditable="true"></div>
  </div>
  <div class="linha-rv">
    <label for="vulnerabilidades">VULNERABILIDADES</label>
    <div id="vulnerabilidades" class="campo-linha-rv" contenteditable="true"></div>
  </div>
  <div class="linha-rv">
    <label for="proficiencias">PROFICIÊNCIAS</label>
    <div id="proficiencias" class="campo-linha-rv" contenteditable="true"></div>
  </div>
</div>
<div class="linha-horizontal"></div>
<div class="linha-horizontal-2"></div>


<div class="container-pericias">
  <div class="lista-pericias-completa">
    <div class="linha-pericia"><span class="pericia">Acrobacia</span><span class="atributo">(AGI)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-acrobacia"></div></div>
    <div class="linha-pericia"><span class="pericia">Atletismo</span><span class="atributo">(FOR)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-atletismo"></div></div>
    <div class="linha-pericia"><span class="pericia">Bloqueio</span><span class="atributo">(FOR)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-bloqueio"></div></div>
    <div class="linha-pericia"><span class="pericia">Canalização</span><span class="atributo">(PRE)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-canalizacao"></div></div>
    <div class="linha-pericia"><span class="pericia">Combate</span><span class="atributo">(FOR)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-combate"></div></div>
    <div class="linha-pericia"><span class="pericia">Condução</span><span class="atributo">(AGI)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-conducao"></div></div>
    <div class="linha-pericia"><span class="pericia">Enganação</span><span class="atributo">(PRE)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-enganacao"></div></div>
    <div class="linha-pericia"><span class="pericia">Esquiva</span><span class="atributo">(AGI)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-esquiva"></div></div>
    <div class="linha-pericia"><span class="pericia">Fortitude</span><span class="atributo">(VIG)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-fortitude"></div></div>
    <div class="linha-pericia"><span class="pericia">Furtividade</span><span class="atributo">(AGI)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-furtividade"></div></div>
    <div class="linha-pericia"><span class="pericia">Influência</span><span class="atributo">(PRE)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-intimidacao"></div></div>
    <div class="linha-pericia"><span class="pericia">Iniciativa</span><span class="atributo">(AGI)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-iniciativa"></div></div>
    <div class="linha-pericia"><span class="pericia">Intuição</span><span class="atributo">(PRE)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-intuicao"></div></div>
    <div class="linha-pericia"><span class="pericia">Investigação</span><span class="atributo">(INT)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-investigacao"></div></div>
    <div class="linha-pericia"><span class="pericia">Ladinagem</span><span class="atributo">(AGI)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-ladinagem"></div></div>
    <div class="linha-pericia"><span class="pericia">Medicina</span><span class="atributo">(INT)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-medicina"></div></div>
    <div class="linha-pericia"><span class="pericia">Ofício</span><span class="atributo">(INT)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-oficio"></div></div>
    <div class="linha-pericia"><span class="pericia">Precisão</span><span class="atributo">(AGI)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-percepcao"></div></div>
    <div class="linha-pericia"><span class="pericia">Percepção</span><span class="atributo">(PRE)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-precisao"></div></div>
    <div class="linha-pericia"><span class="pericia">Religião</span><span class="atributo">(INT)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-religiao"></div></div>
    <div class="linha-pericia"><span class="pericia">Sobrevivência</span><span class="atributo">(INT)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-sobrevivencia"></div></div>
    <div class="linha-pericia"><span class="pericia">Tecnologia</span><span class="atributo">(INT)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-tecnologia"></div></div>
    <div class="linha-pericia"><span class="pericia">Vontade</span><span class="atributo">(PRE)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-vontade"></div></div>
  </div>
</div>

<div class="abas">
  <div class="aba ativa" onclick="trocarAba('habilidades')">HABILIDADES</div>
  <div class="aba" onclick="trocarAba('inventario')">INVENTÁRIO</div>
  <div class="aba" onclick="trocarAba('idolos')">ÍDOLOS</div>
  <div class="aba" onclick="trocarAba('anotacoes')">ANOTAÇÕES</div>
</div>

<div class="conteudos">
  <div class="conteudo-aba" id="habilidades" style="display: block;">
    <!-- Coloca o conteúdo de HABILIDADES aqui -->
     <div class="habilidades-container">
  <div class="habilidades-linha">
    <span class="habilidades-titulo">PH</span>
    <div class="campo-editavel pequeno" contenteditable="true" id="info-ph">0/0</div>
  </div>
  <div class="campo-editavel grande" contenteditable="true" id="campo-habilidades"><br></div>
</div>

  </div>
  <div class="conteudo-aba" id="inventario">
    <!-- Conteúdo do INVENTÁRIO -->
  <div class="inventario-container">
  <div class="inventario-linha">
    <span class="inventario-titulo">CARGA</span>
    <div class="campo-editavel pequeno" contenteditable="true" id="carga">0/0</div>
  </div>
  <div class="campo-editavel grande" contenteditable="true" id="itens"><br></div>
</div>

  </div>
  <div class="conteudo-aba" id="idolos">
    <!-- Conteúdo de ÍDOLOS -->
     <div class="idolos-container">
  <div class="campo-editavel grande" contenteditable="true" id="campo-idolos"><br></div>
</div>

  </div>
  <div class="conteudo-aba" id="anotacoes">
    <!-- Conteúdo de ANOTAÇÕES -->
    <div class="notas-container">
  <div class="campo-editavel grande" contenteditable="true" id="notas"><br></div>
  </div>
</div>


  <script>
    const personagemId = new URLSearchParams(window.location.search).get("page");
    if (!personagemId) {
      alert("Adicione ?page=nome na URL");
      throw new Error("Sem personagem");
    }

    function handleImage(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const base64 = e.target.result;
          document.getElementById('preview').src = base64;
          db.ref("imagem/" + personagemId).set(base64);
        }
        reader.readAsDataURL(file);
      }
    }

    function salvarTexto(id) {
  const valor = document.getElementById(id).innerHTML; // salva formatação HTML
  db.ref("texto/" + personagemId + "/" + id).set(valor);
}


    function carregarDados() {
      db.ref("imagem/" + personagemId).once("value", snap => {
        if (snap.exists()) document.getElementById("preview").src = snap.val();
      });

      [
  "edit-vig", "edit-agi", "edit-for", "edit-pre", "edit-int",
  "info-nome", "info-idade", "info-raca", "info-lvl", "info-mov",
  "info-ph", "campo-habilidades", "carga", "itens", "campo-idolos","notas",
  "resistencias", "vulnerabilidades", "proficiencias", 
  

].forEach(id => {
db.ref("texto/" + personagemId + "/" + id).once("value", snap => {
  if (snap.exists()) document.getElementById(id).innerHTML = snap.val(); // restaura o HTML
});
  document.getElementById(id).addEventListener("input", () => salvarTexto(id));
});


      ["hp", "alma", "sanidade"].forEach(tipo => {
        db.ref(`${tipo}/${personagemId}`).on("value", snap => {
          if (snap.val()) {
            document.getElementById(`${tipo}-input`).value = snap.val();
            tipo === "hp" ? updateHP(snap.val(), false) : updateBar(tipo, snap.val(), false);
          }
        });
      });
    }
    function salvarPericia(id) {
  const valor = document.getElementById(id).innerText;
  db.ref("pericias/" + personagemId + "/" + id).set(valor);
}

    const idsPericias = [
  "pericia-acrobacia", "pericia-atletismo", "pericia-bloqueio", "pericia-canalizacao", "pericia-combate",
  "pericia-conducao", "pericia-enganacao", "pericia-esquiva", "pericia-fortitude", "pericia-furtividade",
  "pericia-iniciativa", "pericia-intimidacao", "pericia-intuicao", "pericia-investigacao", "pericia-medicina",
  "pericia-oficio", "pericia-precisao", "pericia-percepcao", "pericia-religiao", "pericia-sobrevivencia",
  "pericia-tecnologia", "pericia-vontade", "pericia-ladinagem"
];

idsPericias.forEach(id => {
  const el = document.getElementById(id);
  if (!el) return;

  // Carrega valor salvo
db.ref("pericias/" + personagemId + "/" + id).once("value", snap => {
  if (snap.exists()) {
    el.innerText = snap.val();
    verificarCorPericia(id); // aplica roxo se tiver conteúdo
  }
});

// verifica se tinha sido salvo como roxo mesmo se vazio (forçado)
db.ref("pericias/" + personagemId + "/" + id + "_cor").once("value", snap => {
  if (snap.exists()) {
    el.closest(".linha-pericia").classList.add("roxa");
  }
});


  // Salva alterações
  el.addEventListener("input", () => {
  salvarPericia(id);
  verificarCorPericia(id);
});

});


    document.addEventListener("DOMContentLoaded", carregarDados);

function updateHP(value, salvar = true) {
  let [current, max] = value.split("/").map(Number);
  const bar = document.getElementById("hp-bar");
  const negativeHpBar = document.getElementById("negative-hp-bar");
  const excessoBar = document.getElementById("hp-excesso");
  const input = document.getElementById("hp-input");
  const dead = document.getElementById("dead-message");

  if (!isNaN(current) && !isNaN(max) && max > 0) {
    if (salvar) db.ref("hp/" + personagemId).set(value);

    const maxNegative = Math.floor(max / 2);
    let currentInt = current < 0 ? Math.floor(current) : Math.floor(current);

    if (currentInt < -maxNegative) currentInt = -maxNegative;

    const perc = (current / max) * 100;
    bar.style.width = Math.max(0, perc) + "%";

    // barra preta (negativa)
    let negativePercent = 0;
    if (currentInt < 0) {
      negativePercent = Math.floor((-currentInt / maxNegative) * 100);
      if (negativePercent > 100) negativePercent = 100;
    }
    negativeHpBar.style.width = negativePercent + "%";

    // barra laranja (excesso)
    if (current > max) {
      const excesso = ((current - max) / max) * 100;
      excessoBar.style.width = Math.min(excesso, 100) + "%";
    } else {
      excessoBar.style.width = "0%";
    }

    // cor da barra principal e status de morte
    if (currentInt <= 0) {
      if (currentInt <= -maxNegative) {
        bar.style.backgroundColor = "black";
        dead.style.display = "block";
        input.style.opacity = "0";
      } else {
        bar.style.backgroundColor = "black";
        dead.style.display = "none";
        input.style.opacity = "1";
      }
    } else if (perc > 50) {
      bar.style.backgroundColor = "rgb(182, 36, 36)";
      dead.style.display = "none";
      input.style.opacity = "1";
    } else {
      bar.style.backgroundColor = "rgb(121, 26, 26)";
      dead.style.display = "none";
      input.style.opacity = "1";
    }
  } else {
    bar.style.width = "0";
    negativeHpBar.style.width = "0";
    excessoBar.style.width = "0";
    bar.style.backgroundColor = "black";
    dead.style.display = "none";
    input.style.opacity = "1";
  }
}


    function changeHP(amount) {
      const input = document.getElementById("hp-input");
      let [current, max] = input.value.split("/").map(Number);
      if (!isNaN(current) && !isNaN(max) && max > 0) {
        current = Math.max(Math.floor(-max / 2), current + amount);
        input.value = `${current}/${max}`;
        updateHP(input.value);
      }
    }

    function updateBar(tipo, value, salvar = true) {
      const [current, max] = value.split("/").map(Number);
      const bar = document.getElementById(`${tipo}-bar`);
      if (!isNaN(current) && !isNaN(max) && max > 0) {
        if (salvar) db.ref(`${tipo}/${personagemId}`).set(value);
        const perc = (current / max) * 100;
        bar.style.width = Math.max(0, perc) + "%";
      } else {
        bar.style.width = "0%";
      }
    }

    function changeBar(tipo, amount) {
      const input = document.getElementById(`${tipo}-input`);
      let [current, max] = input.value.split("/").map(Number);
      if (!isNaN(current) && !isNaN(max) && max > 0) {
        current = Math.max(0,(max, current + amount));
        input.value = `${current}/${max}`;
        updateBar(tipo, input.value);
      }
    }
document.getElementById('campo-habilidades').addEventListener('keydown', function(e) {
  const campo = this;

  if (e.key === ' ' || e.code === 'Space') {
    const sel = window.getSelection();
    const range = sel.getRangeAt(0);
    const node = range.startContainer;

    const textBeforeCursor = node.textContent?.substring(0, range.startOffset) || '';

    if (textBeforeCursor.endsWith('-')) {
      e.preventDefault();

      // Remove o "-" digitado
      node.textContent = textBeforeCursor.slice(0, -1);

      // Insere o marcador de lista
      document.execCommand('insertHTML', false, '• ');
    }
  }

  if (e.key === 'Enter') {
    setTimeout(() => {
      const sel = window.getSelection();
      if (!sel.rangeCount) return;
      const range = sel.getRangeAt(0);
      const container = range.startContainer;

      // Pega o elemento direto dentro do contenteditable que contém o cursor
      function getLineNode(node) {
        while (node && node !== campo) {
          if (node.parentNode === campo) return node;
          node = node.parentNode;
        }
        return null;
      }

      const currentLine = getLineNode(container);
      if (!currentLine) return;

      // Se a linha nova estiver vazia, insere o marcador
      if (currentLine.textContent.trim() === '') {
        // Remove <br> se for único nó (pode atrapalhar)
        if (currentLine.childNodes.length === 1 && currentLine.firstChild.nodeName === 'BR') {
          currentLine.removeChild(currentLine.firstChild);
        }

        // Cria o marcador
        const marcadorSpan = document.createElement('span');
        marcadorSpan.textContent = '• ';
        marcadorSpan.contentEditable = 'false';
        marcadorSpan.style.userSelect = 'none';

        // Insere no começo da linha
        currentLine.insertBefore(marcadorSpan, currentLine.firstChild);

        // Texto invisível para posicionar o cursor depois do marcador
        const zwsp = document.createTextNode('\u200B');
        currentLine.insertBefore(zwsp, marcadorSpan.nextSibling);

        // Move o cursor para depois do marcador
        const newRange = document.createRange();
        newRange.setStart(zwsp, 1);
        newRange.collapse(true);

        sel.removeAllRanges();
        sel.addRange(newRange);
      }
    }, 0);
  }
});
function trocarAba(abaId) {
  document.querySelectorAll(".aba").forEach(el => el.classList.remove("ativa"));
  document.querySelectorAll(".conteudo-aba").forEach(el => el.style.display = "none");

  document.querySelector(`.aba[onclick*="${abaId}"]`).classList.add("ativa");
  document.getElementById(abaId).style.display = "block";
}
// Verifica se o campo tem valor e aplica classe roxa
function verificarCorPericia(id) {
  const el = document.getElementById(id);
  const linha = el.closest(".linha-pericia");

  if (!linha) return;

  const valor = el.innerText.trim();
  if (valor !== "") {
    linha.classList.add("roxa");
    db.ref("pericias/" + personagemId + "/" + id + "_cor").set(true);
  } else {
    linha.classList.remove("roxa");
    db.ref("pericias/" + personagemId + "/" + id + "_cor").remove();
  }
}
document.getElementById('itens').addEventListener('keydown', function(e) {
  const campo = this;

  if (e.key === ' ' || e.code === 'Space') {
    const sel = window.getSelection();
    const range = sel.getRangeAt(0);
    const node = range.startContainer;

    const textBeforeCursor = node.textContent?.substring(0, range.startOffset) || '';

    if (textBeforeCursor.endsWith('-')) {
      e.preventDefault();

      // Remove o "-" digitado
      node.textContent = textBeforeCursor.slice(0, -1);

      // Insere o marcador de lista
      document.execCommand('insertHTML', false, '• ');
    }
  }

  if (e.key === 'Enter') {
    setTimeout(() => {
      const sel = window.getSelection();
      if (!sel.rangeCount) return;
      const range = sel.getRangeAt(0);
      const container = range.startContainer;

      // Pega o elemento direto dentro do contenteditable que contém o cursor
      function getLineNode(node) {
        while (node && node !== campo) {
          if (node.parentNode === campo) return node;
          node = node.parentNode;
        }
        return null;
      }

      const currentLine = getLineNode(container);
      if (!currentLine) return;

      // Se a linha nova estiver vazia, insere o marcador
      if (currentLine.textContent.trim() === '') {
        // Remove <br> se for único nó (pode atrapalhar)
        if (currentLine.childNodes.length === 1 && currentLine.firstChild.nodeName === 'BR') {
          currentLine.removeChild(currentLine.firstChild);
        }

        // Cria o marcador
        const marcadorSpan = document.createElement('span');
        marcadorSpan.textContent = '• ';
        marcadorSpan.contentEditable = 'false';
        marcadorSpan.style.userSelect = 'none';

        // Insere no começo da linha
        currentLine.insertBefore(marcadorSpan, currentLine.firstChild);

        // Texto invisível para posicionar o cursor depois do marcador
        const zwsp = document.createTextNode('\u200B');
        currentLine.insertBefore(zwsp, marcadorSpan.nextSibling);

        // Move o cursor para depois do marcador
        const newRange = document.createRange();
        newRange.setStart(zwsp, 1);
        newRange.collapse(true);

        sel.removeAllRanges();
        sel.addRange(newRange);
      }
    }, 0);
  }
});
document.getElementById('campo-idolos').addEventListener('keydown', function(e) {
  const campo = this;

  if (e.key === ' ' || e.code === 'Space') {
    const sel = window.getSelection();
    const range = sel.getRangeAt(0);
    const node = range.startContainer;

    const textBeforeCursor = node.textContent?.substring(0, range.startOffset) || '';

    if (textBeforeCursor.endsWith('-')) {
      e.preventDefault();

      // Remove o "-" digitado
      node.textContent = textBeforeCursor.slice(0, -1);

      // Insere o marcador de lista
      document.execCommand('insertHTML', false, '• ');
    }
  }

  if (e.key === 'Enter') {
    setTimeout(() => {
      const sel = window.getSelection();
      if (!sel.rangeCount) return;
      const range = sel.getRangeAt(0);
      const container = range.startContainer;

      // Pega o elemento direto dentro do contenteditable que contém o cursor
      function getLineNode(node) {
        while (node && node !== campo) {
          if (node.parentNode === campo) return node;
          node = node.parentNode;
        }
        return null;
      }

      const currentLine = getLineNode(container);
      if (!currentLine) return;

      // Se a linha nova estiver vazia, insere o marcador
      if (currentLine.textContent.trim() === '') {
        // Remove <br> se for único nó (pode atrapalhar)
        if (currentLine.childNodes.length === 1 && currentLine.firstChild.nodeName === 'BR') {
          currentLine.removeChild(currentLine.firstChild);
        }

        // Cria o marcador
        const marcadorSpan = document.createElement('span');
        marcadorSpan.textContent = '• ';
        marcadorSpan.contentEditable = 'false';
        marcadorSpan.style.userSelect = 'none';

        // Insere no começo da linha
        currentLine.insertBefore(marcadorSpan, currentLine.firstChild);

        // Texto invisível para posicionar o cursor depois do marcador
        const zwsp = document.createTextNode('\u200B');
        currentLine.insertBefore(zwsp, marcadorSpan.nextSibling);

        // Move o cursor para depois do marcador
        const newRange = document.createRange();
        newRange.setStart(zwsp, 1);
        newRange.collapse(true);

        sel.removeAllRanges();
        sel.addRange(newRange);
      }
    }, 0);
  }
});
function updateBar(tipo, value, salvar = true) {
  const [current, max] = value.split("/").map(Number);
  const bar = document.getElementById(`${tipo}-bar`);
  const excesso = document.getElementById(`${tipo}-excesso`);

  if (!isNaN(current) && !isNaN(max) && max > 0) {
    if (salvar) db.ref(`${tipo}/${personagemId}`).set(value);

    const basePerc = Math.min(100, (current / max) * 100);
    const excessoPerc = current > max ? ((current - max) / max) * 100 : 0;

    bar.style.width = basePerc + "%";
    excesso.style.width = excessoPerc + "%";
  } else {
    bar.style.width = "0%";
    excesso.style.width = "0%";
  }
}

  </script>
</body>
</html>
