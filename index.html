
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta charset="UTF-8" />
  <title>Personagem Ru√≠nas</title>
  <style>
    body {
      background-color: #191919;
      font-family: Arial, sans-serif;
      
    }
    .container {
      position: relative;
      width: 100%;
      height: 100%;
    }
    /* Oculta visualmente as barras de rolagem, mas mant√©m a rolagem ativa */
html, body {
  scrollbar-width: none; /* Firefox */
}

html::-webkit-scrollbar,
body::-webkit-scrollbar {
  display: none; /* Chrome, Edge, Safari, Opera */
}
/* Espa√ßamento padr√£o de linha */
[contenteditable="true"] {
  line-height: 1.4;
}

  .paragrafo {
    margin-top: 0px;
    margin-bottom: 16px;
  }





  .paragrafo br {
    line-height: 1.2;
  }

    
.circulos-wrapper {
  position: absolute;
  width: 350px;
  height: 350px;
  margin: 0px auto; /* Centraliza na tela */
  left: 575px;
}

.circulo-principal {
  width: 200px;
  height: 200px;
  border: 3px solid white;
  background-color: transparent;
  position: absolute;
  left: -470px;
  top: 190px;
  overflow: hidden;
  z-index: 1;
}

.circulo-principal img {
  width: 100%;
  height: 100%;
  display: flex;
  object-position: center;
  object-fit: cover;

}

/* Pequenos */
.circulo-menor {
  width: 65px;
  height: 65px;
  border: 3px solid white;
  border-radius: 50%;
  background-color: #191919;
  position: absolute;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2;
}

.circulo-menor span {
  position: absolute;
  color: white;
  font-weight: bold;
  font-size: 15px;
  transform: translateY(110%);
}
.circulo-menor span::before {
  content: "";
  position: absolute;
  top: -3px;
  left: 50%;
  transform: translateX(-50%);
  width: 40px;
  height: 2px;
  background-color: white;
}
    .editavel {
      position: absolute;
      top: 4px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      font-size: 30px;
      font-weight: normal;
      text-align: center;
      outline: none;
      border: none;
      background: transparent;
      width: 60px;
    }

/* POSICIONAMENTO EM VOLTA DO C√çRCULO */
.centro {
  top: 370px;
  left: -125px;
  transform: translate(-50%);
}
.direita {
  top: 470px;
  left: -125px;
  transform: translate(-50%);
}
.direita-cima {
  top: 570px;
  left: -125px;
  transform: translate(-50%);
}
.esquerda {
  top: 270px;
  left: -125px;
  transform: translate(-50%);
}
.esquerda-cima {
  top: 170px;
  left: -125px;
  transform: translate(-50%);
}


    .barras-container {
      position: absolute; /* ou fixed, se quiser que fique fixo mesmo rolando */
      top: 425px;
      left: 50px;
      display: flex;
      flex-direction: column;
    }

    .bloco-barra {
      position: relative;
      width: 300px;
      margin-bottom: 20px;
    }
    .bar-title {
      color: #fff;
      font-weight: bold;
      font-size: 18px;
      text-align: center;
      margin-bottom: 5px;
    }
    .bar-container {
      width: 300px;
      height: 30px;
      background-color: #191919;
      border: 2px solid #fff;
      overflow: hidden; /* MUITO IMPORTANTE */
      position: relative;
  transition: transform 0.2s ease;/
    }
    .bar-container.hp-warning {
  animation: hp-pop-warning 1.6s ease-in-out infinite;
}

.bar-container.hp-critical {
  animation: hp-pop-critical 0.9s ease-in-out infinite;
}
    /* Barras de vida, alma e sanidade */
    .bar, .negative-hp-bar {
      height: 100%;
      width: 0;
      transition: width 0.6s, background-color 0.3s;
    }
    /* Cores espec√≠ficas das barras */
    .bar.hp {
      background-color: rgb(182, 36, 36);
    }
    .bar.alma {
      background-color: rgb(45, 168, 255);
    }
    .bar.sanidade {
      background-color: rgb(103, 1, 171);
    }
    /* Barra negativa de HP (por tr√°s da barra principal) */
    .negative-hp-bar {
      background-color: black;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 0;
    }
    /* Barra extra positiva (excesso) */
    .positive-bar {
      background-color: orange;
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0;
      z-index: 1.5;
      pointer-events: none; /* n√£o interfere em cliques */
      transition: width 0.6s;
    }
    /* Input central dentro da barra */
    .bar-input {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100px;
      border: none;
      background: none;
      color: #fff;
      font-weight: bold;
      text-align: center;
      z-index: 2;
      font-size: 16px;
      transition: opacity 1s;
    }
    /* Setas de controle das barras */
    .arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      color: #fff;
      cursor: pointer;
      z-index: 3;
      user-select: none;
    }
    .arrow.left-single {
      left: 30px;
      font-size: 28px;
    }
    .arrow.right-single {
      right: 30px;
      font-size: 28px;
    }
    .arrow.left-double {
      left: 5px;
      font-size: 28px;
    }
    .arrow.right-double {
      right: 5px;
      font-size: 28px;
    }
    /* Mensagem de "MORTO" */
    .dead-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 18px;
      font-weight: bold;
      display: none;
      z-index: 4;
    }
    
    /* Input file escondido (upload customizado) */
    input[type="file"] {
      display: none;
    }
    /* Container de infos √† esquerda */
    .info-esquerda {
      position: absolute;
      left: 25px;
      top: 10px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      color: white;
    }
    /* Linha dentro do container de infos */
    .info-linha {
  display: flex;
  flex-direction: row; /* linha */
  align-items: center;
  gap: 10px;
}

    /* Labels dentro das linhas */
    .info-linha label {
      min-width: 50px;
      font-weight: bold;
    }
    /* Classe extra pra margem em labels espec√≠ficas */
    .label-mov {
      margin-left: 10px;
    }
    /* Campos edit√°veis gerais */
    .campo-editavel {
      border: 1px solid white;
      padding: 5px 10px;
      color: white;
      background: transparent;
      width: 300px;
      height: 20px;
      outline: none;
      font-size: 15px;
      display: flex;
      align-items: center;
      justify-content: left;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .campo-editavel-arq {
          border: 1px solid white;
      padding: 5px 10px;
      color: white;
      background: transparent;
      width: 255px;
      height: 20px;
      outline: none;
      font-size: 15px;
      display: flex;
      align-items: center;
      justify-content: left;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    /* Vers√£o pequena dos campos edit√°veis */
    .campo-editavel.pequeno {
      width: 50px;
      height: 20px;
      font-size: 25px;
      justify-content: center;
      font-weight: normal;
    }
.habilidades-container {
  position: absolute;
  top: 8%;
  left: 1100px;

  display: flex;
  flex-direction: column;
  gap: 10px;

  width: 370px; /* mesma largura que #campo-habilidades tinha */
  height: 88vh; /* ou a altura que quiser */
  overflow-y: auto; /* rolagem vertical se houver muitas habilidades */
}

    .habilidades-linha {
      display: flex;
      align-items: center;
      gap: 10px;
      color: white;
      font-weight: bold;
      font-size: 20px;
    }
    .titulo-pericias {
  font-size: 18px;
  margin-top: 15px;
  text-align: center;
  font-weight: bold;
  color: white;
  text-transform: uppercase; /* opcional, deixa em mai√∫sculas */
  border-bottom: 2px solid white; /* linha decorativa opcional */
  padding-bottom: 4px;
  display: inline-block; /* permite limitar largura */
  width: 275px; /* largura da linha */
}

    .campo-editavel.grande {
      width: 370px;
      height: 80vh;
      border: 2px solid white;
      color: white;
      background-color: transparent;
      padding: 5px;
      overflow-y: auto;
      overflow-x: hidden;
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: break-word;
      text-align: left;
      line-height: 1.2;
      display: block; 
      overflow-y: auto;
      scrollbar-width: none; /* OU inline-block */
    }
    .container-pericias {
      position: absolute;
      top: 0px;  /* ajuste como quiser */
      left: 630px; /* ajuste como quiser */
      width: 320px;
      height: 100%;
      overflow-y: auto;
      scrollbar-width: none; 
    }
    .lista-pericias-completa {

      display: flex;
      flex-direction: column;
      gap: 7px;
      z-index: 2;
      color: white;
      font-size: 15px;
    }
    .linha-pericia {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .linha-pericia.roxa .pericia,
    .linha-pericia.roxa .atributo {
      color: #ae48ee; /* roxo */
    }
    .pericia {
      width: 130px;
      text-align: left;
      font-weight: normal;
    }
    .atributo {
      width: 50px;
      text-align: left;
      font-weight: normal;
    }
    .campo-editavel-linha {
      border-bottom: 2px solid white;
      min-width: 80px;
      height: 20px;
      color: white;
      outline: none;
      background: transparent;
    }
    /* Container geral das resist√™ncias e vulnerabilidades */
    .resistencias-vulnerabilidades {
      position: absolute;
      top: 675px;
      left: 25px;
      display: flex;
      flex-direction: column;
      color: white;
      font-family: Arial, sans-serif;
    }
    /* Linha com uma resist√™ncia ou vulnerabilidade */
    .linha-rv {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    /* Label da linha */
    .linha-rv label {
      min-width: 165px;
      font-weight: bold;
      font-size: 14px;
    } 
    /* Campo edit√°vel da linha */
    .campo-linha-rv {
      width: 300px; /* largura fixa */
      height: 20px;
      padding: 2px 4px;
      border-bottom: 2px solid white;
      outline: none;
      color: white;
      overflow: auto;
      text-overflow: ellipsis;
        /* üîπ controle de scroll */
  overflow-y: auto;
  overflow-x: hidden;

  /* üîπ esconde scrollbar */
  scrollbar-width: none;        /* Firefox */
  -ms-overflow-style: none;     /* Edge antigo */
}

/* Chrome, Edge, Safari, Opera */
.campo-linha-rv::-webkit-scrollbar {
  display: none;
}
    
    /* Container das abas */
    .abas {
      position: absolute;         /* Define que ser√° posicionado fora do fluxo normal */
      top: 0px;                    /* Posi√ß√£o vertical da aba na tela */
      left: 1020px;                  /* Posi√ß√£o horizontal */
      display: flex;           /* Deixa lado a lado */
      border-bottom: 2px solid #333;
      margin-bottom: 20px;
      font-size: 14px;
    }
    /* Cada aba individual */
    .aba {
      padding: 10px 20px;
      color: white;
      cursor: pointer;
      position: relative;
      font-weight: bold;
    }
    /* Linha roxa embaixo da aba ativa */
    .aba.ativa::after {
      content: "";
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 3px;
      background-color: purple;
      }
    /* Esconde os conte√∫dos que n√£o est√£o ativos */
    .conteudos .conteudo-aba {
      display: none;
    }
    .inventario-container {
      margin-top: 20px;
      position: absolute;
      top: 5%;
      left: 1100px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: auto;
      scrollbar-width: none; 
    }
    .inventario-linha {
      display: flex;
      align-items: center;
      gap: 10px;
      color: white;
      font-weight: bold;
      font-size: 20px;
    }
    .inventario-titulo {
      font-size: 20px;
    }
    .idolos-container {
      margin-top: 20px;
      position: absolute;
      top: 5%;
      left: 1100px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: auto;
      scrollbar-width: none; 
    }
    .notas-container {
      margin-top: 20px;
      position: absolute;
      top: 5%;
      left: 1100px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: auto;
      scrollbar-width: none; 
    }
    @media screen and (max-width: 768px) {
  .container {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
  }
  .circulos-wrapper {
    width: 75vw;  /* 90% da largura da tela */
    height: 75vw; /* mant√©m quadrado */
    position: absolute;
    left: 0px;
  }
  .circulo-principal {
    width: 75%;
  height: 75%;
  border-width: 4px;

  position: absolute;
  left: 68%;
  top: 10px;
  transform: translateX(-50%);
}

  .circulo-menor {
  width: 15vw;
  height: 15vw;
  max-width: 70px;
  max-height: 70px;
  min-width: 40px;
  min-height: 40px;
  border-width: 2px;
  top: 150px;
  position: relative;
}

/* transforma o pai impl√≠cito em grid */
*:has(> .circulo-menor) {
  display: grid;
  grid-auto-flow: column;
  grid-auto-columns: max-content; /* largura real dos c√≠rculos */

  place-content: center;          /* centraliza o grupo inteiro */
  place-items: center;            /* centraliza cada c√≠rculo */

  gap: 4vw;
  padding: 0 5vw;
  box-sizing: border-box;
}

.centro,
.direita,
.direita-cima,
.esquerda,
.esquerda-cima {
  left: 75%;
  transform: none;
}



    .info-esquerda {
    position: absolute;
    top: 350px;
    left: 50%;
    transform: translate(-50%);
    width: 85%;
    height: auto;
  }
    .barras-container {
      position: absolute; /* ou fixed, se quiser que fique fixo mesmo rolando */
      top: 550px;
      left: 50%;
      transform: translate(-50%);
      display: flex;
      flex-direction: column;
    }
    .abas {
      position: absolute;
      top: 1700px;
      left: 50%;
      transform: translate(-50%);
      font-size: 13px;
    }
    .aba {
      padding: 8px;
    }
  .habilidades-container {
    display: flex;
    top: 1750px;
    left: 0px;
    width: 100%;
    padding: 0 20px; /* margem dos lados */
    box-sizing: border-box;
  }
  .inventario-container {
    display: flex;
    top: 1720px;
    left: 0px;
    width: 100%;
    padding: 0 20px; /* margem dos lados */
    box-sizing: border-box
  }
 .card-item {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }

  .idolos-container,
  .notas-container {
    display: flex;
    top: 1730px;
    left: 0px;
    width: 100%;
    padding: 0 20px; /* margem dos lados */
    box-sizing: border-box
  }

  .campo-editavel.grande {
    width: 100%;
    height: 600px;
    margin-bottom: 15px;
    
    left: 0px;
    padding: 0 20px; /* margem dos lados */
    box-sizing: border-box;
  }
     .campo-editavel-arq {
    width: 65%;
    height: 20px;
    margin-bottom: 15px;
    }

  .resistencias-vulnerabilidades {
    position: absolute;
    top: 800px;
    left: 50%;
    transform: translate(-50%);
    margin-top: 20px;
    width: 90%;
  }
  .linha-horizontal {
  position: absolute;
  top: 900px;
  width: 100%;
  height: 2px;
  background-color: white;
  margin: 20px 0; /* opcional, s√≥ pra dar respiro */
}
 .linha-horizontal-2 {
  position: absolute;
  top: 1670px;
  width: 100%;
  height: 2px;
  background-color: white;
  margin: 20px 0; /* opcional, s√≥ pra dar respiro */
}

  .container-pericias {
    position: absolute;
    top: 920px;
    left: 55%;
    transform: translate(-50%);
  }
  .lista-pericias-completa {
    font-size: 18px;
  }
}
/* ===== MINI ABA HOVER (ISOLADA) ===== */
.hover-container {
  position: relative;
  display: inline-block;
  left: 0px;
  top: 0px;
  cursor: pointer;
  transition: transform 0.25s ease;
  z-index: 999;
}

.hover-container:hover {
  transform: scale(1.08);
}

.mini-aba-hover {
  position: absolute;
  top: 50px;
  left: -100px;
  padding: 8px;
  width: 150px;
  height: 130px;
  background-color: rgba(47, 52, 55, 0.5);
  backdrop-filter: blur(6px);
  border-radius: 6px;
  box-shadow: 0 6px 14px rgba(0,0,0,0.4);

  opacity: 0;
  pointer-events: none;
  transition: opacity 0.15s ease;
  z-index: 9999;
}

/* Mostrar no hover */
.hover-container:hover .mini-aba-hover {
  opacity: 1;
  pointer-events: auto;
}

/* Imagem da aba */
.mini-imagem {
  width: 100%;
  border-radius: 4px;
  margin-bottom: 8px;
}

/* Linha dos campos */
.mini-linha {
  display: flex;
   justify-content: center; /* centro */
  gap: 12px;
  margin-top: -20px;
}

/* Campos (bloqueados por padr√£o) */
.mini-editavel {
  flex: 1;
  color: white;
  font-size: 25px;
  min-height: 14px;
  border-bottom: 1px solid rgba(255,255,255,0.35);
  pointer-events: none;
  text-align: center;
}

/* Quando clicar, libera edi√ß√£o */
.mini-aba-hover.editando .mini-editavel {
  pointer-events: auto;
  border-bottom: 1px solid #a88bff;
}
        /* Imagem com pop */
        .pop-image {
            width: 40px;
            cursor: pointer;
            transition: transform 0.25s ease;
            position: absolute;
            top: -5px;
            left: 320px;
        }
        .pop-image:hover {
            transform: scale(1.08);
        }

        /* Overlay */
 #modalOverlay {
    display: none; /* üî• ESSENCIAL */
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    justify-content: center;
    align-items: center;
    z-index: 999999;
}

        /* Container invis√≠vel */
        #modalContent {
            background: transparent;
            padding: 0;
            box-shadow: none;
        }

        /* √Årea edit√°vel (√∫nica coisa vis√≠vel) */
        textarea {
            width: 620px;
            height: 320px;
            background: #2e2e2e; /* cinza escuro estilo Notion */
            color: #fff;
            font-size: 16px;
            padding: 16px;
            border: none;
            outline: none;
            border-radius: 8px;
            resize: vertical;

              overflow-y: auto;

    /* üî• esconder scrollbar */
    scrollbar-width: none;          /* Firefox */
    -ms-overflow-style: none;       /* IE / Edge antigo */
}

/* Chrome, Edge, Safari */
.textarea::-webkit-scrollbar {
    display: none;
        }
        .textarea {
    width: 620px;
    height: 320px;
    background: #2e2e2e; /* cinza escuro estilo Notion */
    color: #fff;
    font-size: 16px;
    padding: 16px;
    border: none;
    outline: none;
    border-radius: 8px;
    resize: vertical;

    overflow-y: auto;
    white-space: pre-wrap;
}
@keyframes hp-pop-warning {
  0% {
    transform: scale(1);
    box-shadow: 0 0 0 rgba(255, 140, 0, 0);
  }
  40% {
    transform: scale(1.02);
    box-shadow: 0 0 14px rgba(255, 0, 0, 0.9);
  }
  100% {
    transform: scale(1);
    box-shadow: 0 0 0 rgba(255, 140, 0, 0);
  }
}

@keyframes hp-pop-critical {
  0% {
    transform: scale(1);
    box-shadow: 0 0 0 rgba(255, 0, 0, 0);
  }
  35% {
    transform: scale(1.04);
    box-shadow: 0 0 22px rgba(255, 0, 0, 0.9);
  }
  100% {
    transform: scale(1);
    box-shadow: 0 0 0 rgba(255, 0, 0, 0);
  }
}
.alma-particles {
  position: absolute;
  top: 28px; /* altura da barra */
  left: 0;
  width: 300px;
  height: 0px;
  pointer-events: none;
  overflow: visible;
}
.alma-particle {
  position: absolute;
  bottom: 0;
  width: 5px;
  height: 5px;
  background: rgba(120, 200, 255, 0.8);
  border-radius: 50%;
  animation: alma-float 2.8s ease-out forwards;
}
@keyframes alma-float {
  0% {
    transform: translateY(0) scale(1);
    opacity: 0;
  }
  20% {
    opacity: 1;
  }
  100% {
    transform: translateY(-30px) scale(0.4);
    opacity: 0;
  }
}
.bar.alma.critica {
  background-color: rgb(25, 90, 160);
}
/* Anima√ß√£o de Sanidade substituindo Alma */
#sanidade-bar.alma-substituta {
  animation: sanidade-alma-shift 8s ease-in-out infinite;
}

@keyframes sanidade-alma-shift {
  0% {
    background-color: rgb(103, 1, 171); /* roxo */
  }
  50% {
    background-color: rgb(45, 168, 255); /* azul da alma */
  }
  100% {
    background-color: rgb(103, 1, 171); /* roxo */
  }
}
/* Container para ra√≠zes/tent√°culos */
.hp-roots-container {
  position: absolute;
  bottom: 0;
  width: 100%;
  height: 300px;
  pointer-events: none;
  overflow: visible;
  z-index: 0;
}

.hp-root {
  position: absolute;
  bottom: 0;
  width: 5px;
  background: black;
  border-radius: 7px;
  transform-origin: bottom center;
  animation: root-sway 8s ease-in-out infinite;
}

.hp-root .branch {
  position: absolute;
  bottom: 50%;
  width: 6px;
  height: 50%;
  background: black;
  border-radius: 4px;
  transform-origin: bottom center;
  animation: branch-sway 8s ease-in-out infinite;
}

@keyframes root-sway {
  0% { transform: rotate(-5deg); }
  50% { transform: rotate(5deg); }
  100% { transform: rotate(-5deg); }
}

@keyframes branch-sway {
  0% { transform: rotate(-15deg); }
  50% { transform: rotate(15deg); }
  100% { transform: rotate(-15deg); }
}

/* Part√≠culas externas */
#hp-particles-container {
  position: absolute;
  top: -150px;
  left: -50px;
  width: calc(60% + 100px);
  height: 180px;
  left: 0px;
  pointer-events: none;
  overflow: visible;
  z-index: 1;
}

.hp-particle {
  position: absolute;
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: rgba(0,0,0,0.7);
  animation: particle-move 6s linear infinite;
}

@keyframes particle-move {
  0% { transform: translate(0,0) scale(1); opacity: 0; }
  10% { opacity: 1; }
  50% { transform: translate(5px, -30px) scale(0.7); }
  100% { transform: translate(-5px, -80px) scale(0.5); opacity: 0; }
}



.buff-toggle {
  background: none;
  border: none;
  cursor: pointer;
  padding: 0;
  position: absolute;
  left: 1030px;
  top: 50px;
}

.buff-toggle img {
  width: 48px;
  height: auto;
  opacity: 0.8;
  transition: transform 0.2s ease, opacity 0.2s ease;
}

.buff-toggle:hover img {
  transform: scale(1.1);
  opacity: 1;
}

.buff-toggle.ativo img {
  filter: drop-shadow(0 0 6px rgba(180, 120, 255, 0.8));
  opacity: 1;
}



/* ===== CONTAINER ===== */
.habilidades-container {
  display: flex;
  flex-direction: column;
  gap: 10px;
    overflow-y: auto; /* mant√©m a rolagem */
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE e Edge antigos */
}

/* Chrome, Edge, Safari */
.habilidades-container::-webkit-scrollbar {
  display: none;
}


/* ===== BOT√ÉO ===== */
.btn-add-habilidade {
  background: none;
  border: 1px dashed #555;
  color: #bbb;
  padding: 8px;
  cursor: pointer;
  font-size: 12px;
}

/* ===== CARD ===== */
.card-habilidade {
  background: linear-gradient(180deg, #1f2023, #16171a);
  border-radius: 8px;
  padding: 10px 12px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  position: relative;
  margin-bottom: 6px;
}
/* ===== TEXTO BRANCO NO CARD ===== */
.card-habilidade {
  color: #ffffff;
}

.card-habilidade .card-nome {
  font-size: 16px;
  font-weight: 700;
}

.card-habilidade .card-desc {
  font-size: 14px;
  line-height: 1.45;
}


.card-habilidade .badge {
  color: #ffffff;
}

.card-habilidade .card-acao {
  color: rgba(255, 255, 255, 0.7);
}

.card-habilidade .card-acao:hover {
  color: #ffffff;
}


/* üî¥ CARD ATIVO (PD) */
.card-habilidade.pd {
  background: linear-gradient(
    135deg,
    #c23a3a 0%,
    #6e1b1b 30%,
    #191919 60%,
    #191919 100%
  );
  border: 1px solid #c23a3a;
}

/* üü¢ CARD PASSIVA */
.card-habilidade.passiva {
  background: linear-gradient(
    135deg,
    #3ac27a 0%,
    #1b6e45 30%,
    #191919 60%,
    #191919 100%
  );
  border: 1px solid #1fa88c;
}

/* topo */
.card-topo {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
}

/* nome */
.card-nome {
  font-size: 14px;
  font-weight: 600;
}

/* descri√ß√£o */
.card-desc {
  font-size: 13px;
  opacity: 0.85;
}

/* ===== BADGES ===== */
.badge {
  font-size: 11px;
  font-weight: bold;
  padding: 3px 8px;
  border-radius: 6px;
  white-space: nowrap;
}

/* PD - vermelho */
.badge-pd {
  background: linear-gradient(135deg, #6e1b1b, #c23a3a);
  color: #fff;
}

/* PASSIVA - verde */
.badge-passiva {
  background: linear-gradient(135deg, #1b6e45, #3ac27a);
  color: #fff;
}

/* ===== A√á√ïES (EDITAR / EXCLUIR) ===== */
.card-acoes {
  display: flex;
  gap: 6px;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.card-habilidade:hover .card-acoes {
  opacity: 1;
}

.card-acao {
  background: none;
  border: none;
  color: rgba(255,255,255,0.6);
  cursor: pointer;
  font-size: 12px;
  padding: 2px;
}

.card-acao:hover {
  color: #fff;
}

/* ===== MODAL ===== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.modal-habilidade {
  background: #1c1d20;
  border-radius: 10px;
  padding: 15px;
  width: 640px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.modal-habilidade input,
.modal-habilidade textarea {
  background: #111;
  border: 1px solid #333;
  color: white;
  padding: 8px;
  border-radius: 5px;
}

.modal-habilidade textarea {
  resize: none;
  height: 80px;
}

.btn-salvar {
  background: linear-gradient(135deg, #5a2d82, #8f3fd1);
  border: none;
  padding: 8px;
  color: white;
  font-weight: bold;
  cursor: pointer;
}
/* badge no canto superior direito */
.card-habilidade .badge {
  position: absolute;
  top: 8px;
  right: 10px;
}

/* a√ß√µes no canto inferior direito */
.card-acoes {
  position: absolute;
  bottom: 6px;
  right: 8px;
  display: flex;
  gap: 6px;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.card-habilidade:hover .card-acoes {
  opacity: 1;
}
#campo-habilidades,
#campo-habilidades-ativo {
  display: none !important;
}


/* üü° EVOLU√á√ÉO */
.card-habilidade.evolucao {
  background: linear-gradient(
    135deg,
    #d6b45a 0%,
    #a3872f 25%,
    #191919 75%
  );
  border: 1px solid #a3872f;
}

/* ‚ö™ RA√áA */
.card-habilidade.raca {
  background: linear-gradient(
    135deg,
    #bdbdbd 0%,
    #7a7a7a 25%,
    #191919 75%
  );
  border: 1px solid #7a7a7a;
}
.card-item {
  background: linear-gradient(135deg, #3a3a3a 20%, #191919 80%);
  border-radius: 8px;
  padding: 10px 12px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  position: relative;
  color: white;
  margin-bottom: 6px;
  border: 1px solid #7a7a7a ; /* üëà ADICIONE ISTO */
}

.card-item.tesouro {
  background: linear-gradient(135deg, #d4af37 20%, #191919 80%);
}

.item-acoes {
  position: absolute;
  bottom: 6px;
  right: 8px;
  display: flex;
  gap: 6px;
  opacity: 0;
}

.card-item:hover .item-acoes {
  opacity: 1;
}
.lista-habilidades:empty {
  display: none;
}
.item-topo {
  display: flex;
  justify-content: space-between;
  font-weight: bold;
}

.item-espaco {
  opacity: 0.8;
}

.item-info {
  font-size: 0.9em;
  opacity: 0.85;
  margin-top: 2px;
}

.item-desc {
  margin-top: 6px;
  font-size: 0.95em;
  transition: max-height 0.3s ease, opacity 0.3s ease;
  overflow: hidden;
}
.item-desc[style*="display: block"] {
  max-height: 500px; /* ou um valor grande suficiente */
  opacity: 1;
}

.item-desc[style*="display: none"] {
  max-height: 0;
  opacity: 0;
}
#itens {
  display: none;
}
.conteudo-aba {
  display: none;         /* esconde todas por padr√£o */
}

.card-habilidade,
.card-item {
  cursor: grab;
}

.card-habilidade:active,
.card-item:active {
  cursor: grabbing;
  z-index: 999;
}
#lista-itens,
#lista-habilidades,
#lista-habilidades-ativo {
  position: relative;
}
.card-item:hover .card-acoes {
  opacity: 1;
}
.item-municao {
  cursor: pointer;
}

  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB3g9cW1262DtgjD-t55iNCM2yYQf6ctTg",
      authDomain: "hp-bar-5337b.firebaseapp.com",
      databaseURL: "https://hp-bar-5337b-default-rtdb.firebaseio.com",
      projectId: "hp-bar-5337b",
      storageBucket: "hp-bar-5337b.appspot.com",
      messagingSenderId: "891062479752",
      appId: "1:891062479752:web:a94ee1b9ba5ddbb826683d",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>
</head>
<body>

  <div class="circulos-wrapper">
    <div class="circulo-principal" onclick="document.getElementById('upload').click()">
      <img id="preview" src="" alt="">
    </div>
    <input type="file" id="upload" accept="image/*" onchange="handleImage(event)" />

    <div class="circulo-menor centro"><div class="editavel" contenteditable="true" id="edit-vig"></div><span>VIG</span></div>
    <div class="circulo-menor direita"><div class="editavel" contenteditable="true" id="edit-agi"></div><span>PRE</span></div>
    <div class="circulo-menor direita-cima"><div class="editavel" contenteditable="true" id="edit-for"></div><span>INT</span></div>
    <div class="circulo-menor esquerda"><div class="editavel" contenteditable="true" id="edit-pre"></div><span>AGI</span></div>
    <div class="circulo-menor esquerda-cima"><div class="editavel" contenteditable="true" id="edit-int"></div><span>FOR</span></div>
  </div>

  <div class="info-esquerda">
  <div class="info-linha">
    <label>NOME</label>
    <div class="campo-editavel" contenteditable="true" id="info-nome"></div>
  </div>
  <div class="info-linha">
    <label>RA√áA</label>
    <div class="campo-editavel" contenteditable="true" id="info-raca"></div>
  </div>
    <div class="info-linha">
    <label>ARQU√âTIPO</label>
    <div class="campo-editavel-arq" contenteditable="true" id="info-idade"></div>
  </div>
  <div class="info-linha">
    <label>LVL</label>
    <div class="campo-editavel pequeno" contenteditable="true" id="info-lvl"></div>
    <label class="label-mov">MOV</label>
    <div class="campo-editavel pequeno" contenteditable="true" id="info-mov"></div>
  </div>
</div>

  <!-- Barras -->
  <div class="barras-container">
  <div class="bloco-barra">
    <div class="bar-title vida">VIDA</div>
    <div class="bar-container">
      <div id="hp-roots-container" class="hp-roots-container"></div>
      <div class="negative-hp-bar" id="negative-hp-bar"></div>
      <div class="positive-bar" id="hp-excesso"></div> <!-- excesso -->
      <div class="bar hp" id="hp-bar"></div>
      <div class="arrow left-single" onclick="changeHP(-1)">‚Äπ</div>
      <div class="arrow right-single" onclick="changeHP(1)">‚Ä∫</div>
      <div class="arrow left-double" onclick="changeHP(-5)">¬´</div>
      <div class="arrow right-double" onclick="changeHP(5)">¬ª</div>
      <input type="text" id="hp-input" class="bar-input" value="0/0" oninput="updateHP(this.value)" />
      <div class="dead-message" id="dead-message">MORTO</div>
    </div>
    <div id="hp-particles-container"></div>
  </div>

  <div class="bloco-barra">
    <div class="bar-title alma">ALMA</div>
    <div class="bar-container">
      <div class="positive-bar" id="alma-excesso"></div> <!-- excesso -->
      <div class="bar alma" id="alma-bar"></div>
      <div class="arrow left-single" onclick="changeBar('alma', -1)">‚Äπ</div>
      <div class="arrow right-single" onclick="changeBar('alma', 1)">‚Ä∫</div>
      <div class="arrow left-double" onclick="changeBar('alma', -5)">¬´</div>
      <div class="arrow right-double" onclick="changeBar('alma', 5)">¬ª</div>
      <input type="text" id="alma-input" class="bar-input" value="0/0" oninput="updateBar('alma', this.value)" />
    </div>
    <div class="alma-particles"></div>
  </div>

  <div class="bloco-barra">
    <div class="bar-title sanidade">DETERMINA√á√ÉO</div>
    <div class="bar-container">
      <div class="positive-bar" id="sanidade-excesso"></div> <!-- excesso -->
      <div class="bar sanidade" id="sanidade-bar"></div>
      <div class="arrow left-single" onclick="changeBar('sanidade', -1)">‚Äπ</div>
      <div class="arrow right-single" onclick="changeBar('sanidade', 1)">‚Ä∫</div>
      <div class="arrow left-double" onclick="changeBar('sanidade', -5)">¬´</div>
      <div class="arrow right-double" onclick="changeBar('sanidade', 5)">¬ª</div>
      <input type="text" id="sanidade-input" class="bar-input" value="0/0" oninput="updateBar('sanidade', this.value)" />
    </div>
  </div>
</div>


<div class="resistencias-vulnerabilidades">
  <div class="linha-rv">
    <label for="campo-resistencias">RESIST√äNCIAS</label>
    <div id="resistencias" class="campo-linha-rv" contenteditable="true"></div>
  </div>
  <div class="linha-rv">
    <label for="vulnerabilidades">VULNERABILIDADES</label>
    <div id="vulnerabilidades" class="campo-linha-rv" contenteditable="true"></div>
  </div>
  <div class="linha-rv">
    <label for="proficiencias">PROFICI√äNCIAS</label>
    <div id="proficiencias" class="campo-linha-rv" contenteditable="true"></div>
  </div>
</div>
<div class="linha-horizontal"></div>
<div class="linha-horizontal-2"></div>


<div class="container-pericias">
  <div class="titulo-pericias">PER√çCIAS</div>
  <div class="lista-pericias-completa">
    <div class="linha-pericia"><span class="pericia">Acrobacia</span><span class="atributo">(AGI)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-acrobacia"></div></div>
    <div class="linha-pericia"><span class="pericia">Atletismo</span><span class="atributo">(FOR)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-atletismo"></div></div>
    <div class="linha-pericia"><span class="pericia">Bloqueio</span><span class="atributo">(FOR)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-bloqueio"></div></div>
    <div class="linha-pericia"><span class="pericia">Canaliza√ß√£o</span><span class="atributo">(PRE)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-canalizacao"></div></div>
    <div class="linha-pericia"><span class="pericia">Ci√™ncias</span><span class="atributo">(INT)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-ciencias"></div></div>
    <div class="linha-pericia"><span class="pericia">Combate</span><span class="atributo">(FOR)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-combate"></div></div>
    <div class="linha-pericia"><span class="pericia">Condu√ß√£o</span><span class="atributo">(AGI)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-conducao"></div></div>
    <div class="linha-pericia"><span class="pericia">Engana√ß√£o</span><span class="atributo">(PRE)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-enganacao"></div></div>
    <div class="linha-pericia"><span class="pericia">Esquiva</span><span class="atributo">(AGI)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-esquiva"></div></div>
    <div class="linha-pericia"><span class="pericia">Fortitude</span><span class="atributo">(VIG)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-fortitude"></div></div>
    <div class="linha-pericia"><span class="pericia">Furtividade</span><span class="atributo">(AGI)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-furtividade"></div></div>
    <div class="linha-pericia"><span class="pericia">Influ√™ncia</span><span class="atributo">(PRE)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-intimidacao"></div></div>
    <div class="linha-pericia"><span class="pericia">Iniciativa</span><span class="atributo">(AGI)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-iniciativa"></div></div>
    <div class="linha-pericia"><span class="pericia">Intui√ß√£o</span><span class="atributo">(PRE)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-intuicao"></div></div>
    <div class="linha-pericia"><span class="pericia">Investiga√ß√£o</span><span class="atributo">(INT)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-investigacao"></div></div>
    <div class="linha-pericia"><span class="pericia">Ladinagem</span><span class="atributo">(AGI)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-ladinagem"></div></div>
    <div class="linha-pericia"><span class="pericia">Medicina</span><span class="atributo">(INT)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-medicina"></div></div>
    <div class="linha-pericia"><span class="pericia">Of√≠cio</span><span class="atributo">(INT)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-oficio"></div></div>
    <div class="linha-pericia"><span class="pericia">Precis√£o</span><span class="atributo">(AGI)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-percepcao"></div></div>
    <div class="linha-pericia"><span class="pericia">Percep√ß√£o</span><span class="atributo">(PRE)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-precisao"></div></div>
    <div class="linha-pericia"><span class="pericia">Religi√£o</span><span class="atributo">(INT)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-religiao"></div></div>
    <div class="linha-pericia"><span class="pericia">Sobreviv√™ncia</span><span class="atributo">(INT)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-sobrevivencia"></div></div>
    <div class="linha-pericia"><span class="pericia">T√°tica</span><span class="atributo">(INT)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-tatica"></div></div>
    <div class="linha-pericia"><span class="pericia">Tecnologia</span><span class="atributo">(INT)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-tecnologia"></div></div>
    <div class="linha-pericia"><span class="pericia">Vontade</span><span class="atributo">(PRE)</span><div class="campo-editavel-linha" contenteditable="true" id="pericia-vontade"></div></div>
  </div>
</div>

<div class="abas">
  <div class="aba ativa" onclick="trocarAba('habilidades')">HABILIDADES</div>
  <div class="aba" onclick="trocarAba('inventario')">INVENT√ÅRIO</div>
  <div class="aba" onclick="trocarAba('idolos')">√çDOLOS</div>
  <div class="aba" onclick="trocarAba('anotacoes')">ANOTA√á√ïES</div>
</div>

<div class="conteudos">
  <div class="conteudo-aba" id="habilidades" style="display: block;">
    <!-- Coloca o conte√∫do de HABILIDADES aqui -->
     <div class="habilidades-container">
  <div class="habilidades-linha">
    <span class="habilidades-titulo">PH</span>
    <div class="campo-editavel pequeno" contenteditable="true" id="info-ph">0/0</div>
        <span class="habilidades-titulo">FOCO</span>
    <div class="campo-editavel pequeno" contenteditable="true" id="info-foco">0/0</div>
  </div>
  <!-- üîπ BOT√ÉO DE ADICIONAR -->
<button class="btn-add-habilidade" onclick="abrirModalNovaHabilidade()">
  + ADICIONAR HABILIDADE
</button>

<!-- üîπ LISTA DE HABILIDADES -->
<div id="lista-habilidades" class="lista-habilidades"></div>
<div id="lista-habilidades-ativo" class="lista-habilidades" style="display: none;"></div>

<!-- üîπ MODAL DE HABILIDADE -->
<div id="modal-habilidade" class="modal-overlay" style="display: none;" onclick="fecharModalHabilidade()">
  <div class="modal-habilidade" onclick="event.stopPropagation()">

    <input id="hab-nome" placeholder="Nome da habilidade">

    <textarea id="hab-desc" placeholder="Descri√ß√£o"></textarea>

    <input id="hab-pd" placeholder="Custo em PD (ex: 1PD)">

    <label class="checkbox-passiva">
      <input type="checkbox" id="hab-passiva">
      Passiva
    </label>
    <label class="checkbox-extra">
  <input type="checkbox" id="hab-evolucao">
  Divino
</label>

<label class="checkbox-extra">
  <input type="checkbox" id="hab-raca">
  Ra√ßa/Arqu√©tipo
</label>
    <button class="btn-salvar" onclick="salvarHabilidade()">SALVAR</button>

  </div>
</div>


    <img
        src="https://i.imgur.com/LPMise3.png"
        class="pop-image"
        id="openModalBtn"
    >

    <div id="modalOverlay" onclick="closeModal()">
        <div id="modalContent" onclick="event.stopPropagation()">
            <div class="textarea" contenteditable="true" id="Avore da alma" spellcheck="false">
    √Årvore da Alma
</div>
        </div>
    </div>
<!-- Campo original -->
<div class="campo-editavel grande" contenteditable="true" id="campo-habilidades"><br></div>

<!-- Campo ativo (duplicado) -->
<div class="campo-editavel grande" contenteditable="true" id="campo-habilidades-ativo" style="display: none;"><br></div>

</div>

  </div>
  <div class="conteudo-aba" id="inventario">
    <!-- Conte√∫do do INVENT√ÅRIO -->
  <div class="inventario-container">
  <div class="inventario-linha">
    <span class="inventario-titulo">CARGA</span>
    <div class="campo-editavel pequeno" contenteditable="true" id="carga">0/0</div>

        <!-- BOT√ÉO -->
    <button class="btn-add-habilidade" onclick="abrirModalItem()">
      + ADICIONAR ITEM
    </button>

    <div class="hover-container">
  <img src="https://i.imgur.com/NkIMxw6.png" width="45">
  

  <div class="mini-aba-hover" id="miniAbaHover">
    <img src="https://imgur.com/2QrgC0D.png" class="mini-imagem">

    <div class="mini-linha">
      <div id="mini1" class="mini-editavel" contenteditable="true">0</div>
      <div id="mini2" class="mini-editavel" contenteditable="true">0</div>
    </div>
  </div>
</div>
  </div>
  <div class="campo-editavel grande" contenteditable="true" id="itens"><br></div>
  
    <!-- LISTA DE ITENS -->
    <div id="lista-itens" class="lista-habilidades"></div>

 <div id="modal-item" class="modal-overlay" style="display: none;" onclick="fecharModalItem()">

  <div class="modal-habilidade" onclick="event.stopPropagation()">

    <input id="item-nome" placeholder="Nome do item">

    <textarea id="item-desc" placeholder="Descri√ß√£o"></textarea>

    <input id="item-espaco" type="number" placeholder="Espa√ßo">

    <input id="item-quantidade" type="number"  placeholder="Quantidade">

    <input id="item-dano" placeholder="Dano (opcional)">

    <label class="checkbox-passiva">
      <input type="checkbox" id="item-tesouro">
      Tesouro
    </label>
    <label>
    <input type="checkbox" id="item-municao" /> Arma de Fogo/Consum√≠vel
  </label>

    <button type="button" class="btn-salvar" onclick="salvarItem()">SALVAR</button>


  </div>
</div>
</div>

</div>


  </div>
  <div class="conteudo-aba" id="idolos">
    <!-- Conte√∫do de √çDOLOS -->
     <div class="idolos-container">
  <div class="campo-editavel grande" contenteditable="true" id="campo-idolos"><br></div>
</div>

  </div>
  <div class="conteudo-aba" id="anotacoes">
    <!-- Conte√∫do de ANOTA√á√ïES -->
    <div class="notas-container">
  <div class="campo-editavel grande" contenteditable="true" id="notas"><br></div>
  </div>
</div>
<button id="sanityHpToggle" class="buff-toggle">
  <img src="https://i.imgur.com/UJOEI1t.png" alt="Buff Sanidade e HP">
</button>


<script>
/* ==============================
   üîπ CONFIGURA√á√ÉO INICIAL
============================== */
const personagemId = new URLSearchParams(window.location.search).get("page");

if (!personagemId) {
  alert("Adicione ?page=nome na URL");
  throw new Error("Sem personagem");
}
/* ==============================
   üîπ INVENT√ÅRIO ‚Äî DADOS
============================== */
let itensInventario = [];
let itemEmEdicao = null;


/* ==============================
   üîπ FUN√á√ïES DE SALVAR E CARREGAR DADOS
============================== */
function salvarTexto(id) {
  const valor = document.getElementById(id).innerHTML;
  db.ref("texto/" + personagemId + "/" + id).set(valor);
}

function carregarDados() {
  // imagem
  db.ref("imagem/" + personagemId).once("value", snap => {
    if (snap.exists()) document.getElementById("preview").src = snap.val();
  });

  // textos comuns
  const camposTexto = [
    "edit-vig","edit-agi","edit-for","edit-pre","edit-int",
    "info-nome","info-idade","info-raca","info-lvl","info-mov",
    "info-ph","info-foco","campo-habilidades","carga","itens","campo-idolos",
    "notas","resistencias","vulnerabilidades","proficiencias","mini1",
    "mini2", "Avore da alma","campo-habilidades-ativo"
  ];

  camposTexto.forEach(id => {
    db.ref("texto/" + personagemId + "/" + id).once("value", snap => {
      if (snap.exists()) document.getElementById(id).innerHTML = snap.val();
    });
    document.getElementById(id).addEventListener("input", () => salvarTexto(id));
  });

  // barras de HP / alma / sanidade
  ["hp", "alma", "sanidade"].forEach(tipo => {
    db.ref(`${tipo}/${personagemId}`).on("value", snap => {
      if (snap.val()) {
        document.getElementById(`${tipo}-input`).value = snap.val();
        tipo === "hp" ? updateHP(snap.val(), false) : updateBar(tipo, snap.val(), false);
      }
    });
  });
  // üîπ CARREGA O ESTADO DO BOT√ÉO HP + SANIDADE
db.ref(`texto/${personagemId}/modoBonus`).once("value", snap => {
  bonusAtivo = snap.exists() ? snap.val() : false;

  // 1Ô∏è‚É£ aplica o toggle antes de carregar cards
  alternarHabilidadesAtivas(bonusAtivo);

  const botao = document.getElementById("sanityHpToggle");
  if (botao) botao.classList.toggle("ativo", bonusAtivo);

  // 2Ô∏è‚É£ agora sim carrega os cards
  carregarHabilidadesFirebase();
  carregarInventarioFirebase();
});



  const hpInput = document.getElementById("hp-input");
  const sanInput = document.getElementById("sanidade-input");
  const campoOriginal = document.getElementById("campo-habilidades");
const campoAtivo = document.getElementById("campo-habilidades-ativo");

if (bonusAtivo) {
  campoOriginal.style.display = "none";
  campoAtivo.style.display = "block";
} else {
  campoOriginal.style.display = "block";
  campoAtivo.style.display = "none";
}
}

function salvarInventarioFirebase() {
  db.ref(`inventario/${personagemId}`).set(itensInventario);
}

function carregarInventarioFirebase() {
  db.ref(`inventario/${personagemId}`).once("value", snap => {
    if (snap.exists()) {
      itensInventario = snap.val();
      renderizarInventario();
    }
  });
}


/* ==============================
   üîπ FUN√á√ÉO DE IMAGEM
============================== */
function handleImage(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    const base64 = e.target.result;
    document.getElementById('preview').src = base64;
    db.ref("imagem/" + personagemId).set(base64);
  };
  reader.readAsDataURL(file);
}

/* ==============================
   üîπ PER√çCIAS
============================== */
const idsPericias = [
  "pericia-acrobacia","pericia-atletismo","pericia-bloqueio","pericia-canalizacao","pericia-combate",
  "pericia-conducao","pericia-enganacao","pericia-esquiva","pericia-fortitude","pericia-furtividade",
  "pericia-iniciativa","pericia-intimidacao","pericia-intuicao","pericia-investigacao","pericia-medicina",
  "pericia-oficio","pericia-precisao","pericia-percepcao","pericia-religiao","pericia-sobrevivencia",
  "pericia-tecnologia","pericia-vontade","pericia-ladinagem","pericia-tatica", "pericia-ciencias"
];

function salvarPericia(id) {
  const valor = document.getElementById(id).innerText;
  db.ref("pericias/" + personagemId + "/" + id).set(valor);
}

function verificarCorPericia(id) {
  const el = document.getElementById(id);
  const linha = el.closest(".linha-pericia");
  if (!linha) return;

  const valor = el.innerText.trim();
  if (valor !== "") {
    linha.classList.add("roxa");
    db.ref("pericias/" + personagemId + "/" + id + "_cor").set(true);
  } else {
    linha.classList.remove("roxa");
    db.ref("pericias/" + personagemId + "/" + id + "_cor").remove();
  }
}

// Inicializa per√≠cias
idsPericias.forEach(id => {
  const el = document.getElementById(id);
  if (!el) return;

  db.ref("pericias/" + personagemId + "/" + id).once("value", snap => {
    if (snap.exists()) {
      el.innerText = snap.val();
      verificarCorPericia(id);
    }
  });

  db.ref("pericias/" + personagemId + "/" + id + "_cor").once("value", snap => {
    if (snap.exists()) el.closest(".linha-pericia").classList.add("roxa");
  });

  el.addEventListener("input", () => {
    salvarPericia(id);
    verificarCorPericia(id);
  });
});

/* ==============================
   üîπ BARRAS DE STATUS (HP, Alma, Sanidade)
============================== */
function updateHP(value, salvar = true) {
  // Extrai n√∫meros e o valor entre par√™nteses (vida tempor√°ria)
  const match = value.match(/^(-?\d+)\s*\/\s*(\d+)(?:\s*\((\-?\d+)\))?$/);
  if (!match) return;

  let current = parseInt(match[1]);
  let max = parseInt(match[2]);
  let extra = parseInt(match[3]) || 0;

  const bar = document.getElementById("hp-bar");
  const container = bar.closest(".bar-container");
  const negative = document.getElementById("negative-hp-bar");
  const excesso = document.getElementById("hp-excesso");
  const input = document.getElementById("hp-input");
  const dead = document.getElementById("dead-message");

  if (max <= 0) return;

  if (salvar) db.ref("hp/" + personagemId).set(value);

  const maxNeg = Math.floor(max / 2);
  current = Math.max(current, -maxNeg);

  // porcentagem base (barra vermelha)
  const perc = (current / max) * 100;
  bar.style.width = Math.max(0, perc) + "%";
  container.classList.remove("hp-warning", "hp-critical");

if (current > 0) {
  if (perc <= 25) {
    container.classList.add("hp-critical");
  } else if (perc <= 50) {
    container.classList.add("hp-warning");
  }
}


  // barra negativa (hp abaixo de 0)
  const negPerc = current < 0 ? Math.min(100, (-current / maxNeg) * 100) : 0;
  negative.style.width = negPerc + "%";

  // excesso padr√£o (ex: 12/10) + adicional entre par√™nteses (10/10 (2))
  let excPerc = 0;
  if (current > max) excPerc = ((current - max) / max) * 100;
  if (extra > 0) excPerc += (extra / max) * 100;
  excesso.style.width = Math.min(excPerc, 100) + "%";

  // Cores e estado
  if (current <= 0) {
    bar.style.backgroundColor = "black";
    dead.style.display = current <= -maxNeg ? "block" : "none";
    input.style.opacity = current <= -maxNeg ? "0" : "1";
  } else {
    bar.style.backgroundColor = perc > 50 ? "rgb(182,36,36)" : "rgb(121,26,26)";
    dead.style.display = "none";
    input.style.opacity = "1";
  }
atualizarRaizesHP(current);
function atualizarRaizesHP(hpAtual) {
  const rootsContainer = document.getElementById("hp-roots-container");
  const particlesContainer = document.getElementById("hp-particles-container");

  rootsContainer.innerHTML = "";
  particlesContainer.innerHTML = "";

  if (hpAtual > 0) return;

  const numRaizes = 15;
  const alturaMax = 150;

  // Criar ra√≠zes principais com ramifica√ß√µes
  for (let i = 0; i < numRaizes; i++) {
    const root = document.createElement("div");
    root.classList.add("hp-root");
    root.style.height = alturaMax + Math.random() * 100 + "px";
    root.style.left = `${(i / numRaizes) * 100}%`;
    root.style.transform = `rotate(${(Math.random() - 0.5) * 400}deg)`;

    const numBranches = 1 + Math.floor(Math.random() * 3);
    for (let b = 0; b < numBranches; b++) {
      const branch = document.createElement("div");
      branch.classList.add("branch");
      branch.style.bottom = 20 + Math.random() * 60 + "%";
      branch.style.transform = `rotate(${(Math.random() - 0.5) * 90}deg)`;
      root.appendChild(branch);
    }

    rootsContainer.appendChild(root);
  }

  // Criar part√≠culas externas
  const numParticulas = 60;
  for (let i = 0; i < numParticulas; i++) {
    const particle = document.createElement("div");
    particle.classList.add("hp-particle");
    particle.style.left = `${Math.random() * 120 - 10}%`;
    particle.style.bottom = `${Math.random() * 50 - 50}px`;
    
    particlesContainer.appendChild(particle);
  }
}

}

/* ==============================
   üîπ EFEITOS VISUAIS ‚Äî ALMA
============================== */
let almaParticleInterval = null;
function criarParticulaAlma() {
  const container = document.querySelector(".alma-particles");
  if (!container) return;

  const p = document.createElement("div");
  p.className = "alma-particle";

  p.style.left = Math.random() * 100 + "%";
  p.style.animationDuration = (3 + Math.random()).toFixed(2) + "s";

  container.appendChild(p);

  setTimeout(() => p.remove(), 3000);
}
function verificarSubstituicaoAlma() {
  const almaInput = document.getElementById("alma-input").value;
  const sanidadeBar = document.getElementById("sanidade-bar");

  const [almaAtual] = almaInput.split("/").map(Number);

  if (almaAtual <= 0) {
    sanidadeBar.classList.add("alma-substituta");
  } else {
    sanidadeBar.classList.remove("alma-substituta");
    sanidadeBar.style.backgroundColor = "rgb(103, 1, 171)"; // volta ao normal
  }
}



/* ==============================
   üîπ OUTRAS BARRAS (Alma, Sanidade, etc)
============================== */
function updateBar(tipo, value, salvar = true) {
  const match = value.match(/^(\d+)\s*\/\s*(\d+)(?:\s*\((\d+)\))?$/);
  if (!match) return;

  let current = parseInt(match[1]);
  let max = parseInt(match[2]);
  let extra = parseInt(match[3]) || 0;

  const bar = document.getElementById(`${tipo}-bar`);
  const excesso = document.getElementById(`${tipo}-excesso`);

  if (max <= 0) return;

  if (salvar) db.ref(`${tipo}/${personagemId}`).set(value);

  const basePerc = Math.min(100, (current / max) * 100);
  let excessoPerc = 0;

  if (current > max) excessoPerc = ((current - max) / max) * 100;
  if (extra > 0) excessoPerc += (extra / max) * 100;

  bar.style.width = basePerc + "%";
  excesso.style.width = Math.min(excessoPerc, 100) + "%";
  // ===== EFEITO VISUAL DE ALMA =====
if (tipo === "alma") {
  const porcentagem = (current / max) * 100;
  const barAlma = document.getElementById("alma-bar");

  if (porcentagem > 50) {
    barAlma.classList.remove("critica");

    if (!almaParticleInterval) {
      almaParticleInterval = setInterval(criarParticulaAlma, 300);
    }
  } else {
    barAlma.classList.add("critica");

    if (almaParticleInterval) {
      clearInterval(almaParticleInterval);
      almaParticleInterval = null;
    }
  }
  if (tipo === "alma") {
  verificarSubstituicaoAlma();
}

}

}

/* ==============================
   üîπ ALTERAR VALORES (Setas)
============================== */
function changeHP(amount) {
  const input = document.getElementById("hp-input");

  // Captura valores com regex (ex: 10/10 (2))
  const match = input.value.match(/^(-?\d+)\s*\/\s*(\d+)(?:\s*\((\-?\d+)\))?$/);
  if (!match) return;

  let current = parseInt(match[1]);
  const max = parseInt(match[2]);
  const extra = parseInt(match[3]) || 0;

  if (isNaN(current) || isNaN(max) || max <= 0) return;

  // Ajusta valor principal
  current = Math.max(Math.floor(-max / 2), current + amount);

  // Atualiza o campo mantendo o extra
  input.value = `${current}/${max}${extra ? ` (${extra})` : ""}`;

  updateHP(input.value);
}

function changeBar(tipo, amount) {
  const input = document.getElementById(`${tipo}-input`);

  // Captura valores com regex (ex: 10/10 (2))
  const match = input.value.match(/^(\d+)\s*\/\s*(\d+)(?:\s*\((\d+)\))?$/);
  if (!match) return;

  let current = parseInt(match[1]);
  const max = parseInt(match[2]);
  const extra = parseInt(match[3]) || 0;

  if (isNaN(current) || isNaN(max) || max <= 0) return;

  // Ajusta valor base
  current = Math.max(0, current + amount);

  // Atualiza mantendo o valor extra
  input.value = `${current}/${max}${extra ? ` (${extra})` : ""}`;

  updateBar(tipo, input.value);
}
/* ==============================
   üîπ ALTERAR VALORES (Setas)
============================== */
function changeHP(amount) {
  const input = document.getElementById("hp-input");

  // Captura valores com regex (ex: 10/10 (2))
  const match = input.value.match(/^(-?\d+)\s*\/\s*(\d+)(?:\s*\((\-?\d+)\))?$/);
  if (!match) return;

  let current = parseInt(match[1]);
  const max = parseInt(match[2]);
  let extra = parseInt(match[3]) || 0;

  if (isNaN(current) || isNaN(max) || max <= 0) return;

  if (amount < 0 && extra > 0) {
    // Diminui o extra primeiro
    extra += amount; // amount √© negativo
    if (extra < 0) {
      current += extra; // restante vai para o HP normal
      extra = 0;
    }
  } else {
    // Aumenta HP base ou extra
    current += amount;
  }

  // Garante que HP m√≠nimo n√£o quebre a barra
  const maxNeg = Math.floor(max / 2);
  current = Math.max(current, -maxNeg);

  // Atualiza o campo
  input.value = `${current}/${max}${extra > 0 ? ` (${extra})` : ""}`;

  updateHP(input.value);
}

function changeBar(tipo, amount) {
  const input = document.getElementById(`${tipo}-input`);

  // Captura valores com regex (ex: 10/10 (2))
  const match = input.value.match(/^(\d+)\s*\/\s*(\d+)(?:\s*\((\d+)\))?$/);
  if (!match) return;

  let current = parseInt(match[1]);
  const max = parseInt(match[2]);
  let extra = parseInt(match[3]) || 0;

  if (isNaN(current) || isNaN(max) || max <= 0) return;

  if (amount < 0 && extra > 0) {
    // Diminui o extra primeiro
    extra += amount; // amount √© negativo
    if (extra < 0) {
      current += extra; // restante vai para o valor base
      extra = 0;
    }
  } else {
    current += amount;
  }

  current = Math.max(0, current);

  // Atualiza mantendo o valor extra
  input.value = `${current}/${max}${extra > 0 ? ` (${extra})` : ""}`;

  updateBar(tipo, input.value);
  
}

function habilitarMarcadores(containerId) {
  const container = document.getElementById(containerId);

  container.addEventListener("beforeinput", function (e) {
    if (e.inputType !== "insertText" || e.data !== " ") return;

    const sel = window.getSelection();
    if (!sel || sel.rangeCount === 0) return;

    const range = sel.getRangeAt(0);
    const bloco = getBlocoAtual(range, container);
    if (!bloco) return;

    const textoAntes = getTextoAntesDoCursor(bloco, range);

    // Subn√≠vel (  - )
    if (/^\s{2,}-\s*$/.test(textoAntes)) {
      e.preventDefault();
      limparTextoAntes(range);
      aplicarMarcador(bloco, "‚óã", true);
      return;
    }

    // Marcador normal ( - )
    if (/^\s*-\s*$/.test(textoAntes)) {
      e.preventDefault();
      limparTextoAntes(range);
      aplicarMarcador(bloco, "‚Ä¢");
    }
  });

  function aplicarMarcador(bloco, simbolo, subnivel = false) {
    // remove marcador antigo se existir
    const antigo = bloco.querySelector(".marcador");
    if (antigo) antigo.remove();

    const marcador = document.createElement("span");
    marcador.className = "marcador";
    marcador.textContent = simbolo + " ";
    marcador.contentEditable = "false";
    marcador.style.userSelect = "none";
    marcador.style.fontSize = subnivel ? "1.3em" : "2em";
    marcador.style.lineHeight = "0.8em";
    marcador.style.verticalAlign = "middle";
    if (subnivel) marcador.style.marginLeft = "20px";

    const zwsp = document.createTextNode("\u200B");
    bloco.insertBefore(marcador, bloco.firstChild);
    bloco.insertBefore(zwsp, marcador.nextSibling);

    // coloca cursor depois do marcador
    const sel = window.getSelection();
    const r = document.createRange();
    r.setStart(zwsp, 1);
    r.collapse(true);
    sel.removeAllRanges();
    sel.addRange(r);
  }

  function limparTextoAntes(range) {
    if (range.startContainer.nodeType === 3) {
      range.startContainer.textContent =
        range.startContainer.textContent.slice(range.startOffset);
    }
  }

  function getTextoAntesDoCursor(bloco, range) {
    let texto = "";
    const walker = document.createTreeWalker(bloco, NodeFilter.SHOW_TEXT, null);
    while (walker.nextNode()) {
      const node = walker.currentNode;
      if (node === range.startContainer) {
        texto += node.textContent.slice(0, range.startOffset);
        break;
      } else {
        texto += node.textContent;
      }
    }
    return texto.replace(/\u200B/g, "");
  }

  function getBlocoAtual(range, container) {
    // Se o cursor estiver diretamente no container, retorna ele
    let node = range.startContainer;
    while (node && node !== container) {
      if (node.nodeType === 1) return node;
      node = node.parentNode;
    }
    return container; // retorna container como fallback
  }
}

// aplica em todos os containers
["campo-habilidades", "itens", "campo-idolos", "notas"].forEach(habilitarMarcadores);



/* ==============================
   üîπ LINHA DIVIS√ìRIA (Ctrl + -)
============================== */
document.addEventListener('keydown', function(e) {
  if (e.ctrlKey && e.key === '-') {
    e.preventDefault();

    const sel = window.getSelection();
    if (!sel.rangeCount) return;

    const range = sel.getRangeAt(0);
    const campo = range.startContainer.closest('[contenteditable="true"]');

    // Apenas campos espec√≠ficos
    const camposPermitidos = ["campo-habilidades","campo-habilidades-ativo", "notas", "itens", "campo-idolos"];
    if (!campo || !camposPermitidos.includes(campo.id)) return;

    // cria a linha branca
    const linha = document.createElement('hr');
    linha.classList.add('linha-divisoria');
    linha.style.border = 'none';
    linha.style.borderTop = '2px solid white';
    linha.style.margin = '10px 0';
    linha.style.width = '100%';

    // insere onde o cursor est√°
    range.insertNode(linha);

    // move o cursor depois da linha
    range.setStartAfter(linha);
    range.collapse(true);
    sel.removeAllRanges();
    sel.addRange(range);

    // salva o campo
    salvarTexto(campo.id);
  }
});

// aplica nos campos desejados
["campo-habilidades", "itens", "campo-idolos"].forEach(habilitarMarcadores);

/* ==============================
   üîπ TROCA DE ABAS
============================== */

function trocarAba(abaId) {
  document.querySelectorAll(".aba").forEach(el => el.classList.remove("ativa"));
  document.querySelectorAll(".conteudo-aba").forEach(el => el.style.display = "none");
  document.querySelector(`.aba[onclick*="${abaId}"]`).classList.add("ativa");
  document.getElementById(abaId).style.display = "block";
}
/* ==============================
   üîπ MODAL DE HABILIDADE
============================== */
/* ==============================
   üîπ MODAL DE ITEM (INVENT√ÅRIO)
============================== */
function abrirModalItem(itemId = null) {
  const modal = document.getElementById("modal-item");
  modal.style.display = "flex";

  limparModalItem(); // limpa todos os campos sempre

  if (itemId !== null) {
    // Estamos editando
    itemEmEdicao = itensInventario.findIndex(i => i.id === itemId);
    const item = itensInventario[itemEmEdicao];
    document.getElementById("item-nome").value = item.nome;
    document.getElementById("item-desc").value = item.desc;
    document.getElementById("item-espaco").value = item.espaco;
    document.getElementById("item-quantidade").value = item.quantidade;
    document.getElementById("item-dano").value = item.dano;
    document.getElementById("item-tesouro").checked = item.tesouro;
    document.getElementById("item-municao").checked = item.municao;
  } else {
    // Criando novo item
    itemEmEdicao = null;
  }
}

function limparModalItem() {
  document.getElementById("item-nome").value = "";
  document.getElementById("item-desc").value = "";
  document.getElementById("item-espaco").value = 0;
  document.getElementById("item-quantidade").value = 1;
  document.getElementById("item-dano").value = "";
  document.getElementById("item-tesouro").checked = false;
  document.getElementById("item-municao").checked = false;
  document.getElementById("item-municao").value = "0/0";
}


function fecharModalItem() {
  document.getElementById("modal-item").style.display = "none";
}

function salvarItem() {
  const nome = document.getElementById("item-nome").value.trim();
  
  const novoItem = {
    id: itemEmEdicao !== null ? itensInventario[itemEmEdicao].id : Date.now().toString(),
    nome: nome || "Novo Item",
    desc: document.getElementById("item-desc").value,
    espaco: Number(document.getElementById("item-espaco").value || 0),
    quantidade: Number(document.getElementById("item-quantidade").value || 1),
    dano: document.getElementById("item-dano").value,
    tesouro: document.getElementById("item-tesouro").checked,
    municao: document.getElementById("item-municao").checked,
    valorMunicao: document.getElementById("item-municao").checked ? "0/0" : null
  };

  if (itemEmEdicao !== null) {
    itensInventario[itemEmEdicao] = novoItem;
  } else {
    itensInventario.push(novoItem);
  }

  // üîπ FECHA O MODAL PRIMEIRO
  fecharModalItem();
  itemEmEdicao = null;

  // üîπ SALVA E RENDERIZA INVENT√ÅRIO
  salvarInventarioFirebase();
  renderizarInventario();
  limparModalItem(); // opcional: limpa campos
}




function renderizarInventario() {
  const lista = document.getElementById("lista-itens");
  lista.innerHTML = "";

  itensInventario.forEach((item, index) => {
    const card = document.createElement("div");
    card.className = "card-item";
    card.dataset.id = item.id;

    if (item.tesouro) card.classList.add("tesouro");

    card.style.width = '370px';
    card.style.boxSizing = 'border-box';

    card.innerHTML = `
      <div style="display: flex; align-items: ${item.dano ? 'flex-start' : 'center'}; justify-content: space-between; width: 100%;">
        <button class="toggle-desc" onclick="toggleDescricao(this)" 
                style="align-self: center; margin-right: 6px; background: transparent; border: none; color: white; padding: 0; cursor: pointer; font-size: 1em;">
          ‚ñº
        </button>
        <div style="flex: 1; min-width: 0;">
          <div style="margin-bottom: ${item.dano ? '2px' : '0'};">
            <span class="item-nome" style="color: white; font-weight: bold;">${item.nome}</span>
            <span class="item-municao" contenteditable="true" 
                  style="display: ${item.municao ? 'inline-block' : 'none'};">${item.valorMunicao || '0/0'}</span>
          </div>
          ${item.dano ? `<div style="font-size: 0.85em; color: #ccc; overflow: hidden;">DANO: ${item.dano}</div>` : ''}
        </div>
        <div style="display: flex; flex-direction: column; align-items: flex-end; min-width: 0;">
          <span class="item-espaco" style="font-size: 1.1em; font-weight: bold; color: white;">${item.espaco}</span>
          <span class="item-quantidade" style="font-size: 0.85em; color: #888;">${item.quantidade}x</span>
        </div>
      </div>
      <div class="card-acoes">
        <button class="card-acao" onclick="editarItemPorId('${item.id}')">‚úé</button>
        <button class="card-acao" onclick="excluirItemPorId('${item.id}')">üóë</button>
      </div>
      <div class="item-desc" style="display: none; width: 100%; border-top: 2px solid white; padding-top: 8px; box-sizing: border-box;">
        ${item.desc}
      </div>
    `;

    if (item.municao) {
      const spanMunicao = card.querySelector(".item-municao");
      spanMunicao.addEventListener("input", () => {
        item.valorMunicao = spanMunicao.innerText;
        salvarInventarioFirebase();
      });
    }

    lista.appendChild(card);

    // üîπ Aqui ativamos o drag para cada card
    ativarDragNoCard(card, lista);
  });
}




function editarItem(index) {
  itemEmEdicao = index; // üî• ESSENCIAL

  const item = itensInventario[index];

  document.getElementById("item-nome").value = item.nome;
  document.getElementById("item-desc").value = item.desc;
  document.getElementById("item-espaco").value = item.espaco;
  document.getElementById("item-quantidade").value = item.quantidade;
  document.getElementById("item-dano").value = item.dano;
  document.getElementById("item-tesouro").checked = item.tesouro;

  document.getElementById("modal-item").style.display = "flex";
}
function editarItemPorId(id) {
  const index = itensInventario.findIndex(i => i.id === id);
  if (index === -1) return;

  itemEmEdicao = index;
  const item = itensInventario[index];

  document.getElementById("item-nome").value = item.nome;
  document.getElementById("item-desc").value = item.desc;
  document.getElementById("item-espaco").value = item.espaco;
  document.getElementById("item-quantidade").value = item.quantidade;
  document.getElementById("item-dano").value = item.dano;
  document.getElementById("item-tesouro").checked = item.tesouro;

  document.getElementById("modal-item").style.display = "flex";
}



function excluirItem(index) {
  itensInventario.splice(index, 1);
  salvarInventarioFirebase();
  renderizarInventario();
  fecharModalItem();
}
function excluirItemPorId(id) {
  itensInventario = itensInventario.filter(i => i.id !== id);
  salvarInventarioFirebase();
  renderizarInventario();
}


/* ===============================
   CONTROLE DE EDI√á√ÉO
================================ */
let cardEmEdicao = null;

/* ===============================
   ABRIR / FECHAR MODAL
================================ */
function abrirModalHabilidade() {
  document.getElementById('modal-habilidade').style.display = 'flex';
}

function fecharModalHabilidade() {
  document.getElementById('modal-habilidade').style.display = 'none';
}

/* ===============================
   LIMPAR MODAL
================================ */
function limparModalHabilidade() {
  document.getElementById('hab-nome').value = '';
  document.getElementById('hab-desc').value = '';
  document.getElementById('hab-pd').value = '';
  document.getElementById('hab-passiva').checked = false;
  document.getElementById('hab-evolucao').checked = false;
  document.getElementById('hab-raca').checked = false;
}

/* ===============================
   NOVA HABILIDADE
================================ */
function abrirModalNovaHabilidade() {
  cardEmEdicao = null;
  limparModalHabilidade();
  abrirModalHabilidade();
}

/* ===============================
   EDITAR HABILIDADE
================================ */
function editarHabilidade(botao) {
  cardEmEdicao = botao.closest('.card-habilidade');

  document.getElementById('hab-nome').value =
    cardEmEdicao.querySelector('.card-nome').innerText;

  document.getElementById('hab-desc').value =
    cardEmEdicao.querySelector('.card-desc').innerText;

  const isPassiva = cardEmEdicao.classList.contains('passiva');
  document.getElementById('hab-passiva').checked = isPassiva;

  const badge = cardEmEdicao.querySelector('.badge');
  document.getElementById('hab-pd').value =
    isPassiva ? '' : badge.innerText;

  abrirModalHabilidade();
}

/* ===============================
   SALVAR HABILIDADE
================================ */
function salvarHabilidade() {
  const nome = document.getElementById("hab-nome").value.trim();
  const desc = document.getElementById("hab-desc").value.trim();
  const pd = document.getElementById("hab-pd").value.trim();
  const passiva = document.getElementById("hab-passiva").checked;
  const evolucao = document.getElementById('hab-evolucao').checked;
  const raca = document.getElementById('hab-raca').checked;


  if (!nome) return;

  if (cardEmEdicao) {
    // üîÑ edi√ß√£o
    cardEmEdicao.querySelector(".card-nome").innerText = nome;
    cardEmEdicao.querySelector(".card-desc").innerText = desc;

cardEmEdicao.classList.remove("passiva", "pd", "evolucao", "raca");

if (passiva) cardEmEdicao.classList.add("passiva");
else cardEmEdicao.classList.add("pd");

if (evolucao) {
  cardEmEdicao.classList.add("evolucao");
} else if (raca) {
  cardEmEdicao.classList.add("raca");
}


    const badge = cardEmEdicao.querySelector(".badge");
    badge.className = `badge ${passiva ? "badge-passiva" : "badge-pd"}`;
    badge.innerText = passiva ? "PASSIVA" : (pd || "PD");
  } else {
    // ‚ûï nova
   criarCardHabilidade({ nome, desc, passiva, pd, evolucao, raca });

  }

  salvarHabilidadesFirebase();
  fecharModalHabilidade();
  limparModalHabilidade();
  cardEmEdicao = null;
}


/* ===============================
   EXCLUIR HABILIDADE
================================ */
function excluirHabilidade(botao) {
  const card = botao.closest(".card-habilidade");
  card.remove();
  salvarHabilidadesFirebase();
}



/* ===============================
   üîπ HABILIDADES ‚Äî FIREBASE
================================ */
function salvarHabilidadesFirebase() {
  const salvarLista = (listaId, caminho) => {
    const lista = document.getElementById(listaId);
    const habilidades = {};
    lista.querySelectorAll(".card-habilidade").forEach(card => {
      const id = card.dataset.id;
habilidades[id] = {
  nome: card.querySelector(".card-nome").innerText,
  desc: card.querySelector(".card-desc").innerHTML,
  passiva: card.classList.contains("passiva"),
  pd: card.classList.contains("passiva") ? "" : card.querySelector(".badge").innerText,
  evolucao: card.classList.contains("evolucao"),
  raca: card.classList.contains("raca")
};

    });
    db.ref(`habilidades/${personagemId}/${caminho}`).set(habilidades);
  }

  salvarLista("lista-habilidades", "normal");
  salvarLista("lista-habilidades-ativo", "ativo");
}



let habilidadesCarregadas = false;

function carregarHabilidadesFirebase() {
  if (habilidadesCarregadas) return;
  habilidadesCarregadas = true;

  const listaNormal = document.getElementById("lista-habilidades");
  const listaAtivo = document.getElementById("lista-habilidades-ativo");

  listaNormal.innerHTML = "";
  listaAtivo.innerHTML = "";

  const carregarLista = (caminho, lista) => {
  db.ref(`habilidades/${personagemId}/${caminho}`).once("value", snap => {
    if (!snap.exists()) return;

    Object.entries(snap.val()).forEach(([id, hab]) => {
      criarCardHabilidade(hab, id, lista.id);
    });

    // ‚¨áÔ∏è aplica ordem salva
    db.ref(`habilidades/${personagemId}/ordem/${caminho}`)
      .once("value", snapOrd => {
        if (snapOrd.exists()) {
          aplicarOrdem(lista, snapOrd.val());
        }
      });
  });
};


  carregarLista("normal", listaNormal);
  carregarLista("ativo", listaAtivo);
}

function toggleDescricao(botao) {
  const card = botao.closest(".card-habilidade");
  if (!card) return;

  const desc = card.querySelector(".card-desc");
  if (!desc) return;

  if (desc.style.display === "none" || desc.style.display === "") {
    desc.style.display = "block";
    botao.textContent = "‚ñ≤";
  } else {
    desc.style.display = "none";
    botao.textContent = "‚ñº";
  }
}


function criarCardHabilidade(dados, id = null, destinoId = null) {
  const card = document.createElement("div");
  card.className = "card-habilidade";

  // tipo base
  if (dados.passiva) card.classList.add("passiva");
  else card.classList.add("pd");

  // prioridade visual
  if (dados.evolucao) {
    card.classList.add("evolucao");
  } else if (dados.raca) {
    card.classList.add("raca");
  }

  const habilidadeId = id || Date.now().toString();
  card.dataset.id = habilidadeId;


  // Limpa o card
card.innerHTML = "";

// Container do topo (seta + nome + badge)
const cardTopo = document.createElement("div");
cardTopo.className = "card-topo";
cardTopo.style.display = "flex";
cardTopo.style.justifyContent = "space-between"; 
cardTopo.style.alignItems = "center";
cardTopo.style.gap = "8px";

// Container esquerda: seta + nome
const esquerda = document.createElement("div");
esquerda.style.display = "flex";
esquerda.style.alignItems = "center";
esquerda.style.gap = "6px";

// Bot√£o de toggle (seta)
const toggleBtn = document.createElement("button");
toggleBtn.className = "toggle-desc";
toggleBtn.textContent = "‚ñº"; // ou use toggleBtn.innerHTML = '<img src="seta.png">';
toggleBtn.style.cursor = "pointer";
toggleBtn.style.background = "transparent"; // fundo transparente
toggleBtn.style.border = "none";           // remove borda
toggleBtn.style.padding = "0";             // remove padding
toggleBtn.style.outline = "none";          // remove outline ao clicar
toggleBtn.style.color = "white";  // seta branca

// Nome
const cardNome = document.createElement("span");
cardNome.className = "card-nome";
cardNome.textContent = dados.nome;

// Adiciona seta e nome no container da esquerda
esquerda.appendChild(toggleBtn);
esquerda.appendChild(cardNome);

// Badge (√† direita)
const badge = document.createElement("span");
badge.className = "badge " + (dados.passiva ? "badge-passiva" : "badge-pd");
badge.textContent = dados.passiva ? "PASSIVA" : (dados.pd || "PD");

// Adiciona esquerda + badge no topo
cardTopo.appendChild(esquerda);
cardTopo.appendChild(badge);

// Linha branca acima da descri√ß√£o
const linha = document.createElement("div");
linha.style.height = "1px";
linha.style.backgroundColor = "white";
linha.style.margin = "6px 0";
linha.style.width = "100%";
linha.style.display = "none"; // come√ßa escondida junto com a descri√ß√£o

// Descri√ß√£o
const cardDesc = document.createElement("div");
cardDesc.className = "card-desc";
cardDesc.style.display = "none";
cardDesc.innerHTML = dados.desc;

// Fun√ß√£o de toggle
toggleBtn.onclick = function() {
  if (cardDesc.style.display === "none") {
    cardDesc.style.display = "block";
    linha.style.display = "block"; // mostra a linha junto
    toggleBtn.textContent = "‚ñ≤";
  } else {
    cardDesc.style.display = "none";
    linha.style.display = "none"; // esconde a linha junto
    toggleBtn.textContent = "‚ñº";
  }
};

// Adiciona topo, linha e descri√ß√£o no card
card.appendChild(cardTopo);
card.appendChild(linha);
card.appendChild(cardDesc);

// A√ß√µes
const cardAcoes = document.createElement("div");
cardAcoes.className = "card-acoes";

const btnEditar = document.createElement("button");
btnEditar.className = "card-acao";
btnEditar.textContent = "‚úé";
btnEditar.onclick = function() { editarHabilidade(this); };

const btnExcluir = document.createElement("button");
btnExcluir.className = "card-acao";
btnExcluir.textContent = "üóë";
btnExcluir.onclick = function() { excluirHabilidade(this); };

cardAcoes.appendChild(btnEditar);
cardAcoes.appendChild(btnExcluir);
card.appendChild(cardAcoes);

  // Define destino correto
  let destino;
  if (destinoId) {
    destino = document.getElementById(destinoId);
  } else {
    destino = document.getElementById(
      document.getElementById('campo-habilidades-ativo').style.display === 'block'
        ? 'lista-habilidades-ativo'
        : 'lista-habilidades'
    );
  }

  destino.appendChild(card);
  ativarDragNoCard(card, destino);

}




/* ==============================
   üîπ EXECU√á√ÉO
============================== */
document.addEventListener("DOMContentLoaded", () => {
  carregarDados();
  carregarInventarioFirebase();
});

document.addEventListener("paste", function (e) {
  const target = e.target;

  if (target.isContentEditable) {
    e.preventDefault();
    const text = (e.clipboardData || window.clipboardData).getData("text/plain");
    document.execCommand("insertText", false, text);
  }
  
});
// Containers que devem usar par√°grafos
const containers = ["campo-habilidades", "itens", "campo-idolos", "notas"];

containers.forEach(id => {
  const campo = document.getElementById(id);

  // Quando o campo ganhar foco, transforma qualquer texto solto em par√°grafos
  campo.addEventListener("focus", () => {
    transformarEmParagrafos(campo);
  });

  // Quando o usu√°rio digitar ou colar
  campo.addEventListener("input", () => {
    transformarEmParagrafos(campo);
  });
});
document.addEventListener("keydown", (e) => {
  if (e.shiftKey && e.code === "KeyC") {
    e.preventDefault();

    const sel = window.getSelection();
    if (!sel.rangeCount) return;

    const campo = sel.focusNode?.parentElement.closest('[contenteditable="true"]');
    if (!campo) return;

    // Salva a sele√ß√£o atual
    const range = sel.getRangeAt(0).cloneRange();

    // Paleta de cores (como Notion)
    const cores = [
      "#ef4444","#f97316","#eab308","#27AE60","#14b8a6","#3b82f6",
      "#8b5cf6","#ec4899","#f87171","#fb923c","#F2C94C","#4ade80",
      "#2dd4bf","#60a5fa","#a78bfa","#f9a8d4","#ffffff","#000000"
    ];

    // Remove qualquer paleta anterior
    const antiga = document.getElementById("paleta-cor-flutuante");
    if (antiga) antiga.remove();

    const paleta = document.createElement("div");
    paleta.id = "paleta-cor-flutuante";
    paleta.style.position = "fixed";
    paleta.style.top = (e.clientY + 5) + "px";
    paleta.style.left = (e.clientX + 5) + "px";
    paleta.style.background = "#1a1a1a";
    paleta.style.padding = "8px";
    paleta.style.borderRadius = "8px";
    paleta.style.display = "flex";
    paleta.style.flexWrap = "wrap";
    paleta.style.zIndex = 9999;
    paleta.style.boxShadow = "0 4px 12px rgba(0,0,0,0.5)";

    cores.forEach(cor => {
      const bolinha = document.createElement("div");
      bolinha.style.width = "24px";
      bolinha.style.height = "24px";
      bolinha.style.borderRadius = "50%";
      bolinha.style.backgroundColor = cor;
      bolinha.style.margin = "4px";
      bolinha.style.cursor = "pointer";
      bolinha.style.border = "2px solid #000";

      bolinha.addEventListener("click", (ev) => {
        ev.stopPropagation();

        // Restaura a sele√ß√£o original
        campo.focus();
        sel.removeAllRanges();
        sel.addRange(range);

        // Aplica a cor
        document.execCommand("foreColor", false, cor);
        salvarTexto(campo.id);
        paleta.remove();
      });

      paleta.appendChild(bolinha);
    });

    document.body.appendChild(paleta);

    // Fecha se clicar fora
    const fechar = (ev) => {
      if (!paleta.contains(ev.target)) {
        paleta.remove();
        document.removeEventListener("click", fechar);
      }
    };
    setTimeout(() => document.addEventListener("click", fechar), 10);
  }
});


// Fun√ß√£o que envolve tudo em div.paragrafo
function transformarEmParagrafos(campo) {
  const nodes = Array.from(campo.childNodes);

  nodes.forEach(node => {
    // Se j√° for par√°grafo, ignora
    if (node.nodeType === 1 && node.classList.contains("paragrafo")) return;

    // Se for texto, cria par√°grafo
    if (node.nodeType === 3 || (node.nodeType === 1 && node.tagName !== "DIV")) {
      const p = document.createElement("div");
      p.className = "paragrafo";
      p.innerHTML = node.textContent || node.innerHTML;
      campo.replaceChild(p, node);
    }
  });
}
  const miniAba = document.getElementById("miniAbaHover");

  // Clique dentro da aba ‚Üí libera edi√ß√£o
  miniAba.addEventListener("click", (e) => {
    e.stopPropagation();
    miniAba.classList.add("editando");
  });

  // Clique fora ‚Üí bloqueia novamente
  document.addEventListener("click", () => {
    miniAba.classList.remove("editando");
  });
      const modal = document.getElementById("modalOverlay");
        const btn = document.getElementById("openModalBtn");

        btn.onclick = () => modal.style.display = "flex";
        function closeModal() {
            modal.style.display = "none";
        }
/* ==============================
   üîπ BOT√ÉO HP + SANIDADE (TOGGLE)
============================== */
let bonusAtivo = false;

document.addEventListener("DOMContentLoaded", () => {
  const botao = document.getElementById("sanityHpToggle");
  if (!botao) return;

  botao.addEventListener("click", () => {
    const hpInput = document.getElementById("hp-input");
    const sanInput = document.getElementById("sanidade-input");

    if (!hpInput || !sanInput) return;

    bonusAtivo = !bonusAtivo;
alternarHabilidadesAtivas(bonusAtivo);



    // üíú Alterna a classe ativo para o brilho roxo
    botao.classList.toggle("ativo", bonusAtivo);

    aplicarBonus(hpInput, bonusAtivo);
    aplicarBonus(sanInput, bonusAtivo);
    db.ref(`texto/${personagemId}/modoBonus`).set(bonusAtivo);
  });
});

function aplicarBonus(input, ativar) {
  const match = input.value.match(/^(-?\d+)\s*\/\s*(\d+)(?:\s*\((\-?\d+)\))?$/);
  if (!match) return;

  let atual = parseInt(match[1]);
  let max = parseInt(match[2]);
  let extra = parseInt(match[3]) || 0;

  if (ativar) {
    atual += 15;
    max += 15;
  } else {
    atual -= 15;
    max -= 15;
  }

  atual = Math.min(atual, max);

  input.value = `${atual}/${max}${extra ? ` (${extra})` : ""}`;

  if (input.id === "hp-input") updateHP(input.value);
  if (input.id === "sanidade-input") updateBar("sanidade", input.value);
}
function alternarHabilidadesAtivas(ativar) {
  // üîπ CAMPOS EDIT√ÅVEIS
  document.getElementById('campo-habilidades').style.display = ativar ? 'none' : 'block';
  document.getElementById('campo-habilidades-ativo').style.display = ativar ? 'block' : 'none';

  // üîπ CARDS
  document.getElementById('lista-habilidades').style.display = ativar ? 'none' : 'block';
  document.getElementById('lista-habilidades-ativo').style.display = ativar ? 'block' : 'none';
}
document.addEventListener("DOMContentLoaded", () => {
  carregarDados();
});

function toggleDescricao(botao) {
  // Encontra o card pai
  const card = botao.closest('.card-item');
  if (!card) return;

  // Encontra a descri√ß√£o dentro do card
  const desc = card.querySelector('.item-desc');
  if (!desc) return;

  // Alterna entre mostrar/esconder
  if (desc.style.display === 'none') {
    desc.style.display = 'block';
    botao.textContent = '‚ñ≤'; // seta para cima
  } else {
    desc.style.display = 'none';
    botao.textContent = '‚ñº'; // seta para baixo
  }
}
function ativarDragNoCard(card, container) {
  card.draggable = true;

  card.addEventListener("dragstart", () => {
    card.classList.add("arrastando");
  });

  card.addEventListener("dragover", e => e.preventDefault());

  card.addEventListener("drop", () => {
    const arrastando = container.querySelector(".arrastando");
    if (!arrastando || arrastando === card) return;
    container.insertBefore(arrastando, card);
  });

  card.addEventListener("dragend", () => {
    card.classList.remove("arrastando");

    // üîπ INVENT√ÅRIO
    if (card.classList.contains("card-item")) {
      const ordem = [...container.children].map(c => c.dataset.id);
      itensInventario = ordem
        .map(id => itensInventario.find(i => i.id === id))
        .filter(Boolean);
      salvarInventarioFirebase();
    }

    // üîπ HABILIDADES
    if (card.classList.contains("card-habilidade")) {
      const tipo = container.id === "lista-habilidades-ativo" ? "ativo" : "normal";
      salvarOrdemHabilidades(container, tipo);
    }
  });
}
function aplicarOrdem(container, ordem) {
  ordem.forEach(id => {
    const card = container.querySelector(`[data-id="${id}"]`);
    if (card) container.appendChild(card);
  });
}
function salvarOrdemHabilidades(container, tipo) {
  const ordem = [...container.children].map(c => c.dataset.id);
  db.ref(`habilidades/${personagemId}/ordem/${tipo}`).set(ordem);
}

</script>

